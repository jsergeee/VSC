{% extends "admin/change_list.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1100px;
        margin: 20px auto;
        height: 600px;
    }

    .fc-event {
        cursor: pointer;
    }

    .view-toggle {
        margin-bottom: 20px;
        text-align: right;
    }

    .view-toggle button {
        margin-left: 10px;
        padding: 8px 16px;
        border: 1px solid #79aec8;
        border-radius: 4px;
        background: white;
        cursor: pointer;
    }

    .view-toggle button.active {
        background: #79aec8;
        color: white;
    }

    .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 10px;
        background: #f8f8f8;
        border-radius: 4px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .legend-color.scheduled {
        background-color: #007bff;
    }

    .legend-color.completed {
        background-color: #28a745;
    }

    .legend-color.overdue {
        background-color: #dc3545;
    }

    .legend-color.cancelled {
        background-color: #fd7e14;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <div class="view-toggle">
            <button id="list-view" class="button {% if not request.GET.view %}active{% endif %}">Список</button>
            <button id="calendar-view"
                class="button {% if request.GET.view == 'calendar' %}active{% endif %}">Календарь</button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color scheduled"></div>
                <span>Запланировано</span>
            </div>
            <div class="legend-item">
                <div class="legend-color completed"></div>
                <span>Проведено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color overdue"></div>
                <span>Просрочено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color cancelled"></div>
                <span>Отменено</span>
            </div>
        </div>

        <div id="calendar-container"
            style="display: {% if request.GET.view == 'calendar' %}block{% else %}none{% endif %};">
            <div id="calendar"></div>
        </div>

        <div id="list-container"
            style="display: {% if request.GET.view == 'calendar' %}none{% else %}block{% endif %};">
            {{ block.super }}
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'ru',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Сегодня',
                month: 'Месяц',
                week: 'Неделя',
                day: 'День'
            },
            slotMinTime: '08:00:00',
            slotMaxTime: '22:00:00',
            allDaySlot: false,

            events: [
                {% for event in events %}
            {
                title: '{{ event.title }}',
                start: '{{ event.date|date:"Y-m-d" }}T{{ event.start_time|time:"H:i:s" }}',
                end: '{{ event.date|date:"Y-m-d" }}T{{ event.end_time|time:"H:i:s" }}',
                color: '{% if event.status == "scheduled" %}#007bff{% elif event.status == "completed" %}#28a745{% elif event.status == "overdue" %}#dc3545{% elif event.status == "cancelled" %}#fd7e14{% endif %}',
                url: '{% url "admin:events_event_change" event.id %}'
            },
            {% endfor %}
        ],

        eventClick: function (info) {
            if (info.event.url) {
                window.location.href = info.event.url;
            }
        }
    });

    calendar.render();

    // Переключение между видами
    document.getElementById('list-view').addEventListener('click', function () {
        window.location.href = window.location.pathname;
    });

    document.getElementById('calendar-view').addEventListener('click', function () {
        window.location.href = window.location.pathname + '?view=calendar';
    });
});
</script>
{% endblock %}