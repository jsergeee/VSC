{% extends 'base.html' %}
{% load static %}
{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è{% endblock %}
{% block extra_css %}
<style>
    .homework-form {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 10px 15px;
        width: 100%;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    select.form-control {
        height: 45px;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        color: white;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        margin-left: 10px;
    }

    .btn-cancel:hover {
        background: #5a6268;
        color: white;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .page-header h2 {
        margin: 0;
        font-size: 1.8rem;
    }

    .page-header p {
        margin: 10px 0 0;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="page-header">
        <h2><i class="fa fa-book mr-2"></i> –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</h2>
        <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É, —á—Ç–æ–±—ã –≤—ã–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫—É</p>
    </div>

    <div class="homework-form">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ —É—á–µ–Ω–∏–∫–∞ (–û–î–ù–û) -->
            <div class="form-group">
                <label for="student">üë§ –£—á–µ–Ω–∏–∫ *</label>
                <select name="student" id="student" class="form-control" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                    {% for student in students %}
                        <option value="{{ student.id }}" data-student-id="{{ student.id }}" {% if selected_student and selected_student.id == student.id %}selected{% endif %}>
                            {{ student.user.get_full_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ (–û–î–ù–û) -->
            <div class="form-group">
                <label for="subject">üìö –ü—Ä–µ–¥–º–µ—Ç *</label>
                <select name="subject" id="subject" class="form-control" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ —É—Ä–æ–∫–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —É—á–µ–Ω–∏–∫–∞ –∏ –ø—Ä–µ–¥–º–µ—Ç–∞) -->
            <div class="form-group" id="lesson-group" style="display: none;">
                <label for="lesson">üìÖ –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —É—Ä–æ–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <select name="lesson" id="lesson" class="form-control">
                    <option value="">-- –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —É—Ä–æ–∫—É --</option>
                </select>
                <small class="text-muted">–ú–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–º—É —É—Ä–æ–∫—É</small>
            </div>

            <!-- –ü–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è (–û–î–ù–û) -->
            <div class="form-group">
                <label for="title">üìù –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è *</label>
                <input type="text" name="title" id="title" class="form-control"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 5, —Å—Ç—Ä. 23" required>
                <small class="text-muted">–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</small>
            </div>

            <!-- –ü–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è -->
            <div class="form-group">
                <label for="description">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è *</label>
                <textarea name="description" id="description" rows="5" class="form-control"
                          placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—á–µ–±–Ω–∏–∫–∞, —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã" required></textarea>
            </div>

            <!-- –ü–æ–ª–µ —Å—Ä–æ–∫–∞ —Å–¥–∞—á–∏ -->
            <div class="form-group">
                <label for="deadline">‚è∞ –°—Ä–æ–∫ —Å–¥–∞—á–∏ *</label>
                <input type="datetime-local" name="deadline" id="deadline"
                       class="form-control" value="{{ default_deadline }}" required>
                <small class="text-muted">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ —Å–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</small>
            </div>

            <!-- –ü–æ–ª–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ -->
            <div class="form-group">
                <label for="attachments">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="file" name="attachments" id="attachments" class="form-control">
                <small class="text-muted">–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å PDF, DOC, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ç.–¥.</small>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <div class="alert alert-info">
                <i class="fa fa-info-circle"></i>
                –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è —É—á–µ–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –∏ –≤ Telegram (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω).
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="form-group text-center mt-4">
                <button type="submit" class="btn-submit">
                    <i class="fa fa-check"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                </button>
                <a href="{% url 'teacher_dashboard' %}#homeworks" class="btn-cancel">
                    <i class="fa fa-times"></i> –û—Ç–º–µ–Ω–∞
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentSelect = document.getElementById('student');
        const subjectSelect = document.getElementById('subject');
        const lessonGroup = document.getElementById('lesson-group');
        const lessonSelect = document.getElementById('lesson');

        function loadLessons() {
            const studentId = studentSelect.value;
            const subjectId = subjectSelect.value;

            if (!studentId || !subjectId) {
                lessonGroup.style.display = 'none';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            lessonSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...</option>';
            lessonGroup.style.display = 'block';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —É—Ä–æ–∫–∏ —É—á–µ–Ω–∏–∫–∞ –ø–æ —ç—Ç–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É
            fetch(`/api/student-completed-lessons/?student_id=${studentId}&subject_id=${subjectId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.lessons && data.lessons.length > 0) {
                        let options = '<option value="">-- –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —É—Ä–æ–∫—É --</option>';
                        data.lessons.forEach(lesson => {
                            options += `<option value="${lesson.id}">${lesson.date} ${lesson.start_time} - ${lesson.topic || '–ë–µ–∑ —Ç–µ–º—ã'}</option>`;
                        });
                        lessonSelect.innerHTML = options;
                    } else {
                        lessonSelect.innerHTML = '<option value="">-- –ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤ –ø–æ —ç—Ç–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É --</option>';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–æ–≤:', error);
                    lessonSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–æ–≤</option>';
                });
        }

        studentSelect.addEventListener('change', loadLessons);
        subjectSelect.addEventListener('change', loadLessons);

        // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã —Å—Ç—É–¥–µ–Ω—Ç –∏ –ø—Ä–µ–¥–º–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–∫–∏
        if (studentSelect.value && subjectSelect.value) {
            loadLessons();
        }
    });
</script>
{% endblock %}