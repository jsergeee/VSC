{% extends 'base.html' %}
{% load static %}
{% block title %}–£—Ä–æ–∫ {{ lesson.subject.name }} - {{ lesson.date }}{% endblock %}
{% block extra_css %}
<style>
    .lesson-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .lesson-header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .lesson-header .badge { font-size: 1rem; padding: 10px 20px; border-radius: 30px; }
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
    }
    .student-photo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #667eea;
    }
    .btn-video {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
        margin-bottom: 10px;
        display: inline-block;
        text-decoration: none;
    }
    .btn-video:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        color: white;
        text-decoration: none;
    }
    .btn-complete {
        background: linear-gradient(45deg, #ffc107, #ff9800);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 50px;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
    }
    .btn-complete:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
    }
    .status-badge { padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 600; }
    .status-scheduled { background: #cce5ff; color: #004085; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-overdue { background: #fff3cd; color: #856404; }

    /* ‚ö° –°–¢–ò–õ–ò –î–õ–Ø –ö–†–£–ü–ù–û–ì–û –°–¢–ê–¢–£–°–ê ‚ö° */
    .status-badge-large {
        font-size: 2.5rem;
        font-weight: 900;
        padding: 30px;
        border-radius: 60px;
        text-align: center;
        margin-bottom: 30px;
        letter-spacing: 2px;
        text-transform: uppercase;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 4px solid;
    }
    .status-scheduled-large {
        background: #cce5ff;
        color: #004085;
        border-color: #004085;
    }
    .status-completed-large {
        background: #d4edda;
        color: #155724;
        border-color: #155724;
    }
    .status-cancelled-large {
        background: #f8d7da;
        color: #721c24;
        border-color: #721c24;
    }
    .status-overdue-large {
        background: #fff3cd;
        color: #856404;
        border-color: #856404;
    }
    .status-rescheduled-large {
        background: #fff3cd;
        color: #856404;
        border-color: #856404;
    }
    .status-no_show-large {
        background: #e2e3e5;
        color: #383d41;
        border-color: #383d41;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .info-label {
        font-weight: 600;
        color: #666;
    }
    .info-value {
        font-weight: 500;
        color: #333;
    }
    .payment-positive {
        color: #28a745;
        font-weight: bold;
    }
    .video-note {
        background: #e8f4fd;
        border-left: 4px solid #2196f3;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    .previous-lesson {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.3s;
    }
    .previous-lesson:hover {
        background: #f8f9fa;
    }
    .previous-lesson:last-child {
        border-bottom: none;
    }
    .link-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .link-box label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    .copy-btn {
        cursor: pointer;
    }
    .student-item {
        border-bottom: 1px solid #e9ecef;
        padding: 10px 0;
    }
    .student-item:last-child {
        border-bottom: none;
    }
    .total-cost {
        font-size: 1.2rem;
        font-weight: bold;
        color: #28a745;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid #e9ecef;
    }

    /* –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê */
    .modal-backdrop {
        z-index: 1040 !important;
    }

    .modal {
        z-index: 1050 !important;
    }

    .modal-content {
        pointer-events: auto !important;
        background-color: #fff !important;
        border: 1px solid rgba(0,0,0,0.2) !important;
        border-radius: 0.3rem !important;
    }

    .modal-footer button,
    .modal-body input,
    .modal-body textarea,
    .modal-body button {
        pointer-events: auto !important;
        cursor: pointer !important;
    }

    .modal-body input,
    .modal-body textarea {
        cursor: text !important;
        background-color: #fff !important;
        border: 1px solid #ced4da !important;
        padding: 0.375rem 0.75rem !important;
        border-radius: 0.25rem !important;
        width: 100% !important;
    }

    .modal-body input:focus,
    .modal-body textarea:focus {
        border-color: #80bdff !important;
        outline: 0 !important;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25) !important;
    }
</style>
{% endblock %}
{% block content %}
<!-- ‚ö° –ö–†–£–ü–ù–´–ô –°–¢–ê–¢–£–° –£–†–û–ö–ê ‚ö° -->
<div class="status-badge-large status-{{ lesson.status }}-large" style="font-size: 2.5rem; padding: 30px; text-align: center;">
    {% if lesson.status == 'scheduled' %}üîµ –£—Ä–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
    {% elif lesson.status == 'completed' %}üü¢ –£—Ä–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω
    {% elif lesson.status == 'cancelled' %}üî¥ –£—Ä–æ–∫ –æ—Ç–º–µ–Ω–µ–Ω
    {% elif lesson.status == 'overdue' %}üü† –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
    {% elif lesson.status == 'rescheduled' %}üü° –£—Ä–æ–∫ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω
    {% elif lesson.status == 'no_show' %}‚ö™ –£—á–∞—â–∏–π—Å—è –Ω–µ —è–≤–∏–ª—Å—è
    {% endif %}
</div>
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
    <div class="lesson-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>{{ lesson.subject.name }}</h1>
                <p class="mb-2">
                    <i class="fa fa-calendar"></i> {{ lesson.date|date:"d.m.Y" }}
                    <i class="fa fa-clock ml-3"></i> {{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}
                </p>
                <p class="mb-0">
                    <span class="badge status-{{ lesson.status }} status-badge">
                        {% if lesson.status == 'scheduled' %}–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
                        {% elif lesson.status == 'completed' %}–ü—Ä–æ–≤–µ–¥–µ–Ω–æ
                        {% elif lesson.status == 'cancelled' %}–û—Ç–º–µ–Ω–µ–Ω–æ
                        {% elif lesson.status == 'overdue' %}–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                        {% elif lesson.status == 'rescheduled' %}–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ
                        {% elif lesson.status == 'no_show' %}–ù–µ—è–≤–∫–∞
                        {% endif %}
                    </span>
                </p>
            </div>
            <div class="col-md-4 text-right">
                {% if lesson.status == 'scheduled' %}
                <span class="zoom-link"
                      style="background: #ffc107; padding: 15px 30px; border-radius: 50px; color: white; font-weight: bold;">
                    <i class="fa fa-hourglass-half"></i> –û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–µ–Ω–∏–∫–∞—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö -->
        <div class="col-md-4">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤ -->
            <div class="info-card">
                <h5><i class="fa fa-users"></i> –£—á–µ–Ω–∏–∫–∏</h5>
                {% for attendance in attendances %}
                <div class="student-item">
                    <div class="row">
                        <div class="col-3">
                            {% if attendance.student_photo %}
                            <img src="{{ attendance.student_photo }}" class="student-photo"
                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;"
                                 alt="{{ attendance.student_name }}">
                            {% else %}
                            <div class="student-photo bg-secondary d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px; border-radius: 50%;">
                                <i class="fa fa-user fa-2x text-white"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-9">
                            <h6 class="mb-1">{{ attendance.student_name }}</h6>
                            <p class="small text-muted mb-1">
                                <i class="fa fa-envelope"></i> {{ attendance.student_email|default:"Email –Ω–µ —É–∫–∞–∑–∞–Ω"|truncatechars:20 }}
                            </p>
                            <!-- –°—Ç–∞—Ç—É—Å —É—á–µ–Ω–∏–∫–∞ -->
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                                <span class="badge badge-{% if attendance.status == 'attended' %}success{% elif attendance.status == 'absent' %}danger{% else %}warning{% endif %}">
                                    {{ attendance.status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="fa fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–∫–µ</p>
                </div>
                {% endfor %}
                <!-- –í–∞—à –≥–æ–Ω–æ—Ä–∞—Ä -->
                <div class="total-cost">
                    <div class="info-row">
                        <span class="info-label">–í–∞—à –≥–æ–Ω–æ—Ä–∞—Ä:</span>
                        <span class="info-value payment-positive">
                            {% if lesson.status == 'completed' %}
                                {{ finance.teacher_payment|floatformat:0 }} ‚ÇΩ
                            {% elif lesson.status == 'scheduled' %}
                                {{ finance.teacher_payment|floatformat:0 }} ‚ÇΩ (–º–∞–∫—Å.)
                            {% else %}
                                <span class="badge badge-secondary">–Ω–µ –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <!-- –í–ò–î–ï–û-–ó–í–û–ù–û–ö JITSI -->
{% if lesson.status == 'scheduled' %}
<div class="info-card">
    <h5><i class="fa fa-video-camera"></i> –í–∏–¥–µ–æ-—É—Ä–æ–∫</h5>
    {% if not lesson.video_room %}
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
    <button onclick="createVideoRoom()" class="btn-video" id="createRoomBtn">
        <i class="fa fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É—Ä–æ–∫–∞
    </button>
    <div id="loading" style="display: none;" class="text-center mt-2">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">–°–æ–∑–¥–∞–Ω–∏–µ...</span>
        </div>
    </div>
    {% else %}
    <!-- –ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ -->
    <div class="alert alert-success">
        <i class="fa fa-check-circle"></i> –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!
    </div>
    {% with room_name="plusprogress-"|add:lesson.id|stringformat:"s"|add:"-"|add:lesson.video_room %}
    <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
    <div class="link-box">
        <label><i class="fa fa-user"></i> –í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="teacherLink"
                   value="https://meet.jit.si/{{ room_name }}#userInfo.displayName={{ request.user.get_full_name|urlencode }}&userInfo.email={{ request.user.email|urlencode }}&config.startWithAudioMuted=false"
                   readonly>
            <div class="input-group-append">
                <button class="btn btn-outline-primary copy-btn" onclick="copyLink('teacherLink')">
                    <i class="fa fa-copy"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="link-box">
        <label><i class="fa fa-users"></i> –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="studentLink"
                   value="https://meet.jit.si/{{ room_name }}#config.startWithAudioMuted=false"
                   readonly>
            <div class="input-group-append">
                <button class="btn btn-outline-primary copy-btn" onclick="copyLink('studentLink')">
                    <i class="fa fa-copy"></i>
                </button>
            </div>
        </div>
        <small class="text-muted">–£—á–µ–Ω–∏–∫–∏ –≤–æ–π–¥—É—Ç –ø–æ–¥ —Å–≤–æ–∏–º–∏ –∏–º–µ–Ω–∞–º–∏</small>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ —É—Ä–æ–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
    <a href="https://meet.jit.si/{{ room_name }}#userInfo.displayName={{ request.user.get_full_name|urlencode }}&userInfo.email={{ request.user.email|urlencode }}&config.startWithAudioMuted=false"
       target="_blank"
       class="btn-video"
       onclick="logVideoEntry()">
        <i class="fa fa-play"></i> –ù–∞—á–∞—Ç—å —É—Ä–æ–∫
    </a>

    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <script>
    function logVideoEntry() {
        fetch('/log-video-entry/{{ lesson.id }}/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        }).catch(error => console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', error));
    }
    </script>

    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <a href="{% url 'teacher_edit_lesson' lesson.id %}" class="btn btn-sm btn-outline-secondary mt-2">
        <i class="fa fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫
    </a>
    {% endwith %}
    {% endif %}
</div>
{% endif %}

<!-- –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<script>
function createVideoRoom() {
    document.getElementById('createRoomBtn').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    fetch(`/api/lesson/{{ lesson.id }}/create-video-room/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
            document.getElementById('createRoomBtn').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        document.getElementById('createRoomBtn').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    });
}

function copyLink(elementId) {
    var copyText = document.getElementById(elementId);
    copyText.select();
    document.execCommand('copy');

    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    var btn = event.target.closest('.copy-btn');
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-check"></i>';
    setTimeout(function() {
        btn.innerHTML = originalHtml;
    }, 2000);
}
</script><!-- –í–ò–î–ï–û-–ó–í–û–ù–û–ö JITSI -->
{% if lesson.status == 'scheduled' %}
<div class="info-card">
    <h5><i class="fa fa-video-camera"></i> –í–∏–¥–µ–æ-—É—Ä–æ–∫</h5>
    {% if not lesson.video_room %}
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
    <button onclick="createVideoRoom()" class="btn-video" id="createRoomBtn">
        <i class="fa fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É—Ä–æ–∫–∞
    </button>
    <div id="loading" style="display: none;" class="text-center mt-2">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">–°–æ–∑–¥–∞–Ω–∏–µ...</span>
        </div>
    </div>
    {% else %}
    <!-- –ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ -->
    <div class="alert alert-success">
        <i class="fa fa-check-circle"></i> –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!
    </div>
    {% with room_name="plusprogress-"|add:lesson.id|stringformat:"s"|add:"-"|add:lesson.video_room %}
    <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
    <div class="link-box">
        <label><i class="fa fa-user"></i> –í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="teacherLink"
                   value="https://meet.jit.si/{{ room_name }}#userInfo.displayName={{ request.user.get_full_name|urlencode }}&userInfo.email={{ request.user.email|urlencode }}&config.startWithAudioMuted=false"
                   readonly>
            <div class="input-group-append">
                <button class="btn btn-outline-primary copy-btn" onclick="copyLink('teacherLink')">
                    <i class="fa fa-copy"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="link-box">
        <label><i class="fa fa-users"></i> –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="studentLink"
                   value="https://meet.jit.si/{{ room_name }}#config.startWithAudioMuted=false"
                   readonly>
            <div class="input-group-append">
                <button class="btn btn-outline-primary copy-btn" onclick="copyLink('studentLink')">
                    <i class="fa fa-copy"></i>
                </button>
            </div>
        </div>
        <small class="text-muted">–£—á–µ–Ω–∏–∫–∏ –≤–æ–π–¥—É—Ç –ø–æ–¥ —Å–≤–æ–∏–º–∏ –∏–º–µ–Ω–∞–º–∏</small>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ —É—Ä–æ–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
    <a href="https://meet.jit.si/{{ room_name }}#userInfo.displayName={{ request.user.get_full_name|urlencode }}&userInfo.email={{ request.user.email|urlencode }}&config.startWithAudioMuted=false"
       target="_blank"
       class="btn-video"
       onclick="logVideoEntry()">
        <i class="fa fa-play"></i> –ù–∞—á–∞—Ç—å —É—Ä–æ–∫
    </a>

    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <script>
    function logVideoEntry() {
        fetch('/log-video-entry/{{ lesson.id }}/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        }).catch(error => console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', error));
    }
    </script>

    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <a href="{% url 'teacher_edit_lesson' lesson.id %}" class="btn btn-sm btn-outline-secondary mt-2">
        <i class="fa fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫
    </a>
    {% endwith %}
    {% endif %}
</div>
{% endif %}

<!-- –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<script>
function createVideoRoom() {
    document.getElementById('createRoomBtn').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    fetch(`/api/lesson/{{ lesson.id }}/create-video-room/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
            document.getElementById('createRoomBtn').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        document.getElementById('createRoomBtn').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    });
}

function copyLink(elementId) {
    var copyText = document.getElementById(elementId);
    copyText.select();
    document.execCommand('copy');

    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    var btn = event.target.closest('.copy-btn');
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-check"></i>';
    setTimeout(function() {
        btn.innerHTML = originalHtml;
    }, 2000);
}
</script>
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ -->
            {% if lesson.status == 'scheduled' %}
            <div class="info-card">
                <h5><i class="fa fa-check-circle"></i> –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞</h5>
                <button onclick="document.getElementById('simpleModal').style.display='block'" class="btn-complete">
                    <i class="fa fa-file-text"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫ –∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
            </div>
            {% endif %}
            <!-- –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ä–æ–∫–∏ -->
            {% if previous_lessons %}
            <div class="info-card">
                <h5><i class="fa fa-history"></i> –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ä–æ–∫–∏</h5>
                {% for prev in previous_lessons %}
                <div class="previous-lesson">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ prev.date|date:"d.m.Y" }} {{ prev.start_time|time:"H:i" }}</strong><br>
                            <small class="text-muted">{{ prev.subject.name }}</small>
                        </div>
                        <a href="{% url 'teacher_lesson_detail' prev.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fa fa-eye"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ä–æ–∫–µ –∏ –æ—Ç—á–µ—Ç -->
        <div class="col-md-8">
            {% if lesson.status == 'completed' and lesson.report %}
            <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç—á–µ—Ç -->
            <div class="info-card">
                <h5><i class="fa fa-file-text"></i> –û—Ç—á–µ—Ç –æ –∑–∞–Ω—è—Ç–∏–∏</h5>
                <p><strong>–¢–µ–º–∞:</strong> {{ lesson.report.topic }}</p>
                <p><strong>–ß—Ç–æ –ø—Ä–æ—à–ª–∏:</strong> {{ lesson.report.covered_material }}</p>
                <p><strong>–î–ó:</strong> {{ lesson.report.homework }}</p>
                <p><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–∞:</strong> {{ lesson.report.student_progress }}</p>
                {% if lesson.report.next_lesson_plan %}
                <p><strong>–ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞:</strong> {{ lesson.report.next_lesson_plan }}</p>
                {% endif %}
            </div>
            <!-- –û—Ü–µ–Ω–∫–∏ –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤ -->
            {% if lesson.feedback %}
            <div class="info-card">
                <h5><i class="fa fa-star"></i> –û—Ü–µ–Ω–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤</h5>
                <div class="text-center">
                    <div class="rating-stars mb-2">
                        {% for i in "12345"|make_list %}
                        {% if forloop.counter <= lesson.feedback.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                    </div>
                    {% if lesson.feedback.comment %}
                    <p>"{{ lesson.feedback.comment }}"</p>
                    {% endif %}
                    <small class="text-muted">{{ lesson.feedback.created_at|date:"d.m.Y H:i" }}</small>
                </div>
            </div>
            {% endif %}
            {% elif lesson.status == 'scheduled' %}
            <!-- –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–∫ -->
            <div class="info-card">
                <h5><i class="fa fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ä–æ–∫–µ</h5>
                <p><i class="fa fa-calendar"></i> <strong>–î–∞—Ç–∞:</strong> {{ lesson.date|date:"d.m.Y" }}</p>
                <p>
                    <i class="fa fa-clock"></i>
                    <strong>–í—Ä–µ–º—è:</strong>
                    {{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}
                </p>
                <p><i class="fa fa-book"></i> <strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> {{ lesson.subject.name }}</p>
                {% if lesson.format %}
                <p><i class="fa fa-tag"></i> <strong>–§–æ—Ä–º–∞—Ç:</strong> {{ lesson.format.name }}</p>
                {% endif %}
                {% if lesson.notes %}
                <hr>
                <p><strong>–ó–∞–º–µ—Ç–∫–∏:</strong><br>{{ lesson.notes }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="simpleModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; z-index: 999999; border-radius: 10px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 20px; margin: -30px -30px 20px -30px; border-radius: 10px 10px 0 0; color: white; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫ {{ lesson.subject.name }}</h3>
        <button onclick="document.getElementById('simpleModal').style.display='none'"
                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;
        </button>
    </div>
    <form method="post" action="{% url 'complete_lesson' lesson.id %}" id="completeLessonForm">
        {% csrf_token %}
        <div style="padding: 0 20px;">
            <div style="background: #e8f4fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <i class="fa fa-info-circle" style="color: #2196f3;"></i> –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞:
                <ul style="margin: 10px 0 0 0;">
                    <li>–° –±–∞–ª–∞–Ω—Å–∞ —É—á–µ–Ω–∏–∫–æ–≤ —Å–ø–∏—à—É—Ç—Å—è —Å—É–º–º—ã —Å–æ–≥–ª–∞—Å–Ω–æ –∏—Ö —Å—Ç–æ–∏–º–æ—Å—Ç–∏</li>
                    <li>–ù–∞ –≤–∞—à –∫–æ—à–µ–ª–µ–∫ –ø–æ—Å—Ç—É–ø–∏—Ç —Å—É–º–º–∞ –∑–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —É—á–µ–Ω–∏–∫–æ–≤</li>
                    <li>–£—á–µ–Ω–∏–∫–∏ —Å–º–æ–≥—É—Ç –æ—Ü–µ–Ω–∏—Ç—å —É—Ä–æ–∫</li>
                </ul>
            </div>
            <!-- –û—Ç–º–µ—Ç–∫–∞ —è–≤–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤ -->
            <div style="margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                <h4 style="margin-top: 0; margin-bottom: 15px; font-size: 1.1rem;">
                    <i class="fa fa-check-circle"></i> –û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
                </h4>
                {% for attendance in attendances %}
                <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <input type="checkbox" name="attended_{{ attendance.id }}"
                           id="attended_{{ attendance.id }}"
                           checked style="width: 20px; height: 20px; margin-right: 15px;">
                    <label for="attended_{{ attendance.id }}" style="flex: 1; cursor: pointer;">
                        <strong>{{ attendance.student_name }}</strong>
                        <span style="color: #28a745; margin-left: 10px;">
                +{{ attendance.teacher_payment|floatformat:0 }} ‚ÇΩ
            </span>
                    </label>
                </div>
                {% empty %}
                <p class="text-muted">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏</p>
                {% endfor %}
                <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6; font-weight: bold;">
                    <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞: </span>
                    <span style="color: #28a745; font-size: 1.2rem;">{{ max_teacher_payment|floatformat:0 }} ‚ÇΩ</span>
                </div>
                <p class="text-muted small" style="margin-top: 10px;">
                    <i class="fa fa-info-circle"></i> –û—Ç–º–µ—Ç—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –Ω–∞ —É—Ä–æ–∫–µ.
                    –í—ã–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∑–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö.
                </p>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">–¢–µ–º–∞ —É—Ä–æ–∫–∞ *</label>
                <input type="text" name="topic" required
                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">–ß—Ç–æ –ø—Ä–æ—à–ª–∏ *</label>
                <textarea name="covered_material" rows="3" required
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ *</label>
                <textarea name="homework" rows="3" required
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–∞ *</label>
                <textarea name="student_progress" rows="2" required
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">–ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞</label>
                <textarea name="next_lesson_plan" rows="2"
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid #dee2e6; text-align: right;">
            <button type="button" onclick="document.getElementById('simpleModal').style.display='none'"
                    style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button type="submit"
                    style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                <i class="fa fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
            </button>
        </div>
    </form>
</div>
<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function createVideoRoom() {
        document.getElementById('createRoomBtn').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        fetch("{% url 'create_video_room' lesson.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
                document.getElementById('createRoomBtn').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            document.getElementById('createRoomBtn').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        });
    }

    function copyLink(elementId) {
        var copyText = document.getElementById(elementId);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand('copy');

        var btn = event.target.closest('.copy-btn');
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa fa-check"></i>';
        setTimeout(function() {
            btn.innerHTML = originalHtml;
        }, 2000);
    }
</script>
{% endblock %}