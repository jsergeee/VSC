{% extends 'base.html' %}
{% load static %}

{% block title %}{% if material %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %} –º–∞—Ç–µ—Ä–∏–∞–ª–∞{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fa fa-file"></i>
                        {% if material %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="form-group mb-3">
                            <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                            <input type="text" class="form-control" id="title" name="title"
                                   value="{{ material.title|default:'' }}" required>
                        </div>

                        <div class="form-group mb-3">
                            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ material.description|default:'' }}</textarea>
                        </div>

                        <div class="form-group mb-3">
                            <label for="material_type">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                            <select class="form-control" id="material_type" name="material_type" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                                <option value="file" {% if material.material_type == 'file' %}selected{% endif %}>üìÑ –§–∞–π–ª</option>
                                <option value="link" {% if material.material_type == 'link' %}selected{% endif %}>üîó –°—Å—ã–ª–∫–∞</option>
                            </select>
                        </div>

                        <div class="form-group mb-3" id="file-upload" style="display: none;">
                            <label for="file">–§–∞–π–ª</label>
                            <input type="file" class="form-control" id="file" name="file">
                            {% if material.file %}
                            <small class="text-muted">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: <a href="{{ material.file.url }}" target="_blank">{{ material.file.name }}</a></small>
                            {% endif %}
                        </div>

                        <div class="form-group mb-3" id="link-input" style="display: none;">
                            <label for="link">–°—Å—ã–ª–∫–∞</label>
                            <input type="url" class="form-control" id="link" name="link"
                                   value="{{ material.link|default:'' }}" placeholder="https://...">
                        </div>

                        <div class="form-group mb-3">
                            <label for="subjects">–ü—Ä–µ–¥–º–µ—Ç—ã</label>
                            <select multiple class="form-control" id="subjects" name="subjects" size="5">
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}"
                                    {% if material and subject in material.subjects.all %}selected{% endif %}>
                                    {{ subject.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</small>
                        </div>

                        <div class="form-group mb-3">
                            <label for="students">–£—á–µ–Ω–∏–∫–∏ (–¥–ª—è –∫–æ–≥–æ —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª)</label>
                            <select multiple class="form-control" id="students" name="students" size="5">
                                {% for student in students %}
                                <option value="{{ student.id }}"
                                    {% if material and student in material.students.all %}selected{% endif %}>
                                    {{ student.user.get_full_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª—É</small>
                        </div>

                        <div class="form-group mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_public" name="is_public"
                                       {% if material.is_public %}checked{% endif %}>
                                <label class="form-check-label" for="is_public">–ü—É–±–ª–∏—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª</label>
                                <small class="d-block text-muted">–ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–∏–¥–Ω—ã –í–°–ï–ú —É—á–µ–Ω–∏–∫–∞–º</small>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –ø—É–±–ª–∏—á–Ω—ã–π, –æ–Ω –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º.
                            –ï—Å–ª–∏ –Ω–µ—Ç - –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.
                        </div>

                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fa fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <a href="{% url 'teacher_dashboard' %}#materials" class="btn btn-secondary btn-lg px-5 ml-2">
                                <i class="fa fa-times"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const typeSelect = document.getElementById('material_type');
        const fileUpload = document.getElementById('file-upload');
        const linkInput = document.getElementById('link-input');

        function toggleFields() {
            const type = typeSelect.value;
            if (type === 'file') {
                fileUpload.style.display = 'block';
                linkInput.style.display = 'none';
                document.getElementById('link').required = false;
                document.getElementById('file').required = true;
            } else if (type === 'link') {
                fileUpload.style.display = 'none';
                linkInput.style.display = 'block';
                document.getElementById('file').required = false;
                document.getElementById('link').required = true;
            } else {
                fileUpload.style.display = 'none';
                linkInput.style.display = 'none';
                document.getElementById('file').required = false;
                document.getElementById('link').required = false;
            }
        }

        typeSelect.addEventListener('change', toggleFields);
        toggleFields(); // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

        // –ü—É–±–ª–∏—á–Ω—ã–π/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–µ–∫–±–æ–∫—Å
        const isPublicCheckbox = document.getElementById('is_public');
        const studentsSelect = document.getElementById('students');

        function toggleStudentsField() {
            if (isPublicCheckbox.checked) {
                studentsSelect.disabled = true;
                studentsSelect.style.opacity = '0.5';
            } else {
                studentsSelect.disabled = false;
                studentsSelect.style.opacity = '1';
            }
        }

        isPublicCheckbox.addEventListener('change', toggleStudentsField);
        toggleStudentsField();
    });
</script>
{% endblock %}