{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if template %}Редактировать{% else %}Создать{% endif %} расписание
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header {% if template %}bg-info{% else %}bg-success{% endif %} text-white">
                    <h4 class="mb-0">
                        <i class="fa {% if template %}fa-edit{% else %}fa-plus-circle{% endif %}"></i>
                        {% if template %}Редактировать{% else %}Создать{% endif %} расписание
                    </h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills mb-3" id="scheduleTypeTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="single-tab" data-toggle="pill" href="#single" role="tab">
                                <i class="fa fa-calendar-plus-o"></i> Разовый урок
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="recurring-tab" data-toggle="pill" href="#recurring" role="tab">
                                <i class="fa fa-repeat"></i> Повторяющееся расписание
                            </a>
                        </li>
                    </ul>

                    <form method="post">
                        {% csrf_token %}

                        <!-- ✅ ОДНО поле для типа (добавьте сюда) -->
                        <input type="hidden" name="repeat_type" id="global_repeat_type" value="single">

                        <!-- Общие поля для всех типов -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="student">Ученик <span class="text-danger">*</span></label>
                                    <select class="form-control" id="student" name="student" required>
                                        <option value="">Выберите ученика...</option>
                                        {% for student in students %}
                                        <option value="{{ student.id }}" {% if template and student in template.students.all %}selected{% endif %}>
                                            {{ student.user.get_full_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="subject">Предмет <span class="text-danger">*</span></label>
                                    <select class="form-control" id="subject" name="subject" required>
                                        <option value="">Выберите предмет...</option>
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}" {% if template and template.subject.id == subject.id %}selected{% endif %}>
                                            {{ subject.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="topic">Тема занятия</label>
                            <input type="text" class="form-control" id="topic" name="topic"
                                   value="{{ template.notes|default:'' }}"
                                   placeholder="Например: Урок 1. Введение">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="start_time">Время начала <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="start_time" name="start_time"
                                           value="{{ template.start_time|time:'H:i'|default:'' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="end_time">Время окончания</label>
                                    <input type="time" class="form-control" id="end_time" name="end_time"
                                           value="{{ template.end_time|time:'H:i'|default:'' }}">
                                    <small class="text-muted">По умолчанию +1 час</small>
                                </div>
                            </div>
                        </div>

                        <!-- Вкладка: Разовый урок -->
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="single" role="tabpanel">
                                <div class="form-group mb-3">
                                    <label for="date">Дата занятия <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="date" name="date"
                                           value="{{ template.start_date|date:'Y-m-d'|default:today }}" required>
                                </div>
                                <!-- ❌ УДАЛИТЕ ЭТОТ input -->
                            </div>

                            <!-- Вкладка: Повторяющееся расписание -->
                            <div class="tab-pane fade" id="recurring" role="tabpanel">
                                <!-- ❌ УДАЛИТЕ ЭТОТ input -->

                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fa fa-calendar"></i> Дни недели</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="monday" value="1"
                                                           {% if template and template.monday %}checked{% endif %}>
                                                    <label class="form-check-label" for="monday">Понедельник</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="tuesday" value="2"
                                                           {% if template and template.tuesday %}checked{% endif %}>
                                                    <label class="form-check-label" for="tuesday">Вторник</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="wednesday" value="3"
                                                           {% if template and template.wednesday %}checked{% endif %}>
                                                    <label class="form-check-label" for="wednesday">Среда</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="thursday" value="4"
                                                           {% if template and template.thursday %}checked{% endif %}>
                                                    <label class="form-check-label" for="thursday">Четверг</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="friday" value="5"
                                                           {% if template and template.friday %}checked{% endif %}>
                                                    <label class="form-check-label" for="friday">Пятница</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="saturday" value="6"
                                                           {% if template and template.saturday %}checked{% endif %}>
                                                    <label class="form-check-label" for="saturday">Суббота</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="weekdays[]" id="sunday" value="7"
                                                           {% if template and template.sunday %}checked{% endif %}>
                                                    <label class="form-check-label" for="sunday">Воскресенье</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="start_date">Дата начала <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control" id="start_date" name="start_date"
                                                   value="{{ template.start_date|date:'Y-m-d'|default:today }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="end_date">Дата окончания</label>
                                            <input type="date" class="form-control" id="end_date" name="end_date"
                                                   value="{{ template.end_date|date:'Y-m-d'|default:'' }}">
                                            <small class="text-muted">Оставьте пустым для бесконечного</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="max_occurrences">Максимум занятий</label>
                                            <input type="number" class="form-control" id="max_occurrences" name="max_occurrences"
                                                   value="{{ template.max_occurrences|default:'' }}" min="1" placeholder="10">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="notes">Заметки</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3">{{ template.notes|default:'' }}</textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary">
                                <i class="fa fa-arrow-left"></i> Назад
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fa fa-save"></i>
                                {% if template %}Сохранить{% else %}Создать{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Обновляем repeat_type при переключении вкладок
    document.getElementById('single-tab')?.addEventListener('click', function() {
        document.getElementById('global_repeat_type').value = 'single';
    });

    document.getElementById('recurring-tab')?.addEventListener('click', function() {
        document.getElementById('global_repeat_type').value = 'weekly';
    });
</script>
{% endblock %}