{% extends 'base.html' %}
{% load static %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É—á–∏—Ç–µ–ª—è{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    .form {
        margin: 0px;
        padding: 6px!important;
    }
    .form-control {
        padding: 0px!important;
    }

    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: #495057 !important;
    }

    .fc-button {
        background: #f8f9fa !important;
        border: 2px solid #e9ecef !important;
        color: #495057 !important;
        font-weight: 600 !important;
        padding: 8px 15px !important;
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }

    .fc-button:hover {
        background: #667eea !important;
        border-color: #667eea !important;
        color: white !important;
    }

    .fc-button-active {
        background: #667eea !important;
        border-color: #667eea !important;
        color: white !important;
    }

    .btn-create {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .btn-create i {
        margin-right: 8px;
        font-size: 1.1rem;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #667eea;
        line-height: 1.2;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .nav-tabs-custom {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 25px;
        padding: 0 15px;
    }

    .nav-tabs-custom .nav-item {
        margin-bottom: -2px;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 15px 25px;
        border-radius: 0;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .nav-tabs-custom .nav-link i {
        margin-right: 8px;
        font-size: 1.1rem;
    }

    .nav-tabs-custom .nav-link:hover {
        color: #667eea;
    }

    .nav-tabs-custom .nav-link.active {
        color: #667eea;
        background: transparent;
        border-bottom: 2px solid #667eea;
    }

    .tab-content {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        min-height: 400px;
    }

    .avatar-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .material-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ user.first_name }}!</h2>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number">{{ students.count }}</div>
            <div class="stat-label">–£—á–µ–Ω–∏–∫–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ upcoming_lessons|length }}</div>
            <div class="stat-label">–ë–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ today_lessons|length }}</div>
            <div class="stat-label">–ó–∞–Ω—è—Ç–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ materials|length }}</div>
            <div class="stat-label">–ú–æ–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs-custom" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab">
                <i class="fa fa-calendar"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="students-tab" data-toggle="tab" href="#students" role="tab">
                <i class="fa fa-users"></i> –ú–æ–∏ —É—á–µ–Ω–∏–∫–∏
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="homeworks-tab" data-toggle="tab" href="#homeworks" role="tab">
                <i class="fa fa-book"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="payments-tab" data-toggle="tab" href="#payments" role="tab">
                <i class="fa fa-money"></i> –í—ã–ø–ª–∞—Ç—ã
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="materials-tab" data-toggle="tab" href="#materials" role="tab">
                <i class="fa fa-file"></i> –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab">
                <i class="fa fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π
            </a>
        </li>
    </ul>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å) -->
        <div class="tab-pane fade show active" id="schedule" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
                <div class="d-flex gap-2">
                    <form method="get" action="{% url 'teacher_export_calendar_pdf' %}" class="d-flex gap-2" target="_blank">
                        <select name="month" class="form-control form-control-sm" style="width: 120px;">
                            <option value="1" {% if now.month == 1 %}selected{% endif %}>–Ø–Ω–≤–∞—Ä—å</option>
                            <option value="2" {% if now.month == 2 %}selected{% endif %}>–§–µ–≤—Ä–∞–ª—å</option>
                            <option value="3" {% if now.month == 3 %}selected{% endif %}>–ú–∞—Ä—Ç</option>
                            <option value="4" {% if now.month == 4 %}selected{% endif %}>–ê–ø—Ä–µ–ª—å</option>
                            <option value="5" {% if now.month == 5 %}selected{% endif %}>–ú–∞–π</option>
                            <option value="6" {% if now.month == 6 %}selected{% endif %}>–ò—é–Ω—å</option>
                            <option value="7" {% if now.month == 7 %}selected{% endif %}>–ò—é–ª—å</option>
                            <option value="8" {% if now.month == 8 %}selected{% endif %}>–ê–≤–≥—É—Å—Ç</option>
                            <option value="9" {% if now.month == 9 %}selected{% endif %}>–°–µ–Ω—Ç—è–±—Ä—å</option>
                            <option value="10" {% if now.month == 10 %}selected{% endif %}>–û–∫—Ç—è–±—Ä—å</option>
                            <option value="11" {% if now.month == 11 %}selected{% endif %}>–ù–æ—è–±—Ä—å</option>
                            <option value="12" {% if now.month == 12 %}selected{% endif %}>–î–µ–∫–∞–±—Ä—å</option>
                        </select>
                        <select name="year" class="form-control form-control-sm" style="width: 100px;">
                            <option value="2024" {% if now.year == 2024 %}selected{% endif %}>2024</option>
                            <option value="2025" {% if now.year == 2025 %}selected{% endif %}>2025</option>
                            <option value="2026" {% if now.year == 2026 %}selected{% endif %}>2026</option>
                            <option value="2027" {% if now.year == 2027 %}selected{% endif %}>2027</option>
                            <option value="2028" {% if now.year == 2028 %}selected{% endif %}>2028</option>
                        </select>
                        <button type="submit" class="btn btn-success btn-sm">üìÑ –≠–∫—Å–ø–æ—Ä—Ç</button>
                    </form>
                </div>
            </div>
            <div class="calendar-header">
                <a href="{% url 'teacher_create_schedule' %}" class="btn-create">
                    <i class="fa fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫ / —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                </a>
            </div>
            <div class="row">
                <div class="col-12">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <h4 class="section-title mb-4">–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è</h4>
                    {% if past_lessons %}
                        {% for lesson in past_lessons %}
                        <a href="{% url 'teacher_lesson_detail' lesson.id %}" style="text-decoration: none; color: inherit">
                            <div class="lesson-item completed p-3 mb-3 border rounded hover-shadow" style="transition: all 0.3s; display: block; background: white">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <strong>{{ lesson.date|date:"d.m.Y" }}</strong><br/>
                                        <small class="text-muted">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>{{ lesson.subject.name }}</strong><br/>
                                        <small class="text-muted">
                                            {% for attendance in lesson.attendance.all %}
                                                {{ attendance.student.user.get_full_name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </small>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="badge badge-success px-3 py-2">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</span>
                                    </div>
                                    <div class="col-md-3 text-right">
                                        {% if lesson.report %}
                                        <span class="badge badge-info px-3 py-2 mr-2"><i class="fa fa-file-text"></i> –û—Ç—á–µ—Ç</span>
                                        {% endif %}
                                        {% if lesson.feedback %}
                                        <span class="badge badge-warning px-3 py-2"><i class="fa fa-star"></i> –û—Ü–µ–Ω–∫–∞: {{ lesson.feedback.rating }}/5</span>
                                        {% else %}
                                        <span class="badge badge-secondary px-3 py-2"><i class="fa fa-star"></i> –ù–µ—Ç –æ—Ü–µ–Ω–∫–∏</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 text-right">
                                        <small class="text-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</small>
                                    </div>
                                </div>
                                {% if lesson.feedback and lesson.feedback.comment %}
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <div class="bg-light p-2 rounded">
                                            <i class="fa fa-quote-left text-muted mr-2"></i>
                                            {{ lesson.feedback.comment|truncatechars:100 }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fa fa-history fa-4x text-muted mb-3"></i>
                        <h5>–ù–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π</h5>
                        <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
        <div class="tab-pane fade" id="homeworks" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fa fa-book mr-2"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h4>
                        <a href="{% url 'teacher_homework_create' %}" class="btn-create" style="padding: 8px 15px;">
                            <i class="fa fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </a>
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="stat-card" style="padding: 15px;">
                                <div class="stat-number" style="font-size: 1.8rem;">{{ homework_stats.total }}</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card" style="padding: 15px;">
                                <div class="stat-number" style="font-size: 1.8rem; color: #ffc107;">{{ homework_stats.pending }}</div>
                                <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card" style="padding: 15px;">
                                <div class="stat-number" style="font-size: 1.8rem; color: #17a2b8;">{{ homework_stats.submitted }}</div>
                                <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card" style="padding: 15px;">
                                <div class="stat-number" style="font-size: 1.8rem; color: #28a745;">{{ homework_stats.checked }}</div>
                                <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card" style="padding: 15px;">
                                <div class="stat-number" style="font-size: 1.8rem; color: #dc3545;">{{ homework_stats.overdue }}</div>
                                <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                            </div>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –î–ó -->
                    <h5 class="mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h5>
                    {% if recent_homeworks %}
                        {% for homework in recent_homeworks %}
                        <a href="{% url 'teacher_homework_detail' homework.id %}" style="text-decoration: none; color: inherit;">
                            <div class="lesson-item p-3 mb-2 border rounded" style="background: white; transition: all 0.3s;">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <strong>{{ homework.title }}</strong><br>
                                        <small class="text-muted">{{ homework.subject.name }}</small>
                                    </div>
                                    <div class="col-md-2">
                                        <i class="fa fa-user"></i> {{ homework.student.user.get_full_name }}
                                    </div>
                                    <div class="col-md-2">
                                        <small><i class="fa fa-calendar"></i> {{ homework.created_at|date:"d.m.Y" }}</small>
                                    </div>
                                    <div class="col-md-2">
                                        <small><i class="fa fa-clock-o"></i> –¥–æ {{ homework.deadline|date:"d.m.Y H:i" }}</small>
                                    </div>
                                    <div class="col-md-2">
                                        {% if homework.get_status == 'pending' %}
                                        <span class="badge badge-warning px-3 py-2">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                                        {% elif homework.get_status == 'submitted' %}
                                        <span class="badge badge-info px-3 py-2">üì§ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                        {% elif homework.get_status == 'checked' %}
                                        <span class="badge badge-success px-3 py-2">‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                        {% elif homework.get_status == 'overdue' %}
                                        <span class="badge badge-danger px-3 py-2">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1 text-right">
                                        <i class="fa fa-chevron-right text-muted"></i>
                                    </div>
                                </div>
                                {% if homework.submission and homework.submission.status == 'submitted' %}
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <div class="bg-light p-2 rounded">
                                            <i class="fa fa-exclamation-circle text-warning"></i> –û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}

                        {% if all_homeworks.count > 10 %}
                        <div class="text-center mt-3">
                            <a href="{% url 'teacher_homeworks' %}" class="btn btn-outline-primary">
                                –í—Å–µ –∑–∞–¥–∞–Ω–∏—è ({{ all_homeworks.count }})
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fa fa-book fa-4x text-muted mb-3"></i>
                        <h5>–ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</h5>
                        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</p>
                        <a href="{% url 'teacher_homework_create' %}" class="btn btn-primary">
                            <i class="fa fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–æ–∏ —É—á–µ–Ω–∏–∫–∏ -->
        <div class="tab-pane fade" id="students" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <h4 class="mb-4"><i class="fa fa-users mr-2"></i> –ú–æ–∏ —É—á–µ–Ω–∏–∫–∏</h4>

                    {% if students %}
                    <div class="row">
                        {% for student in students %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="avatar-circle bg-primary text-white mr-3">
                                            {{ student.user.first_name|first|default:student.user.username|first|upper }}
                                        </div>
                                        <div>
                                            <h5 class="mb-0">{{ student.user.get_full_name }}</h5>
                                            <small class="text-muted">
                                                <i class="fa fa-envelope"></i> {{ student.user.email|default:"–Ω–µ—Ç email" }}
                                            </small>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <p class="mb-1"><i class="fa fa-phone"></i> {{ student.user.phone|default:"–Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞" }}</p>
                                        {% if student.parent_name %}
                                        <p class="mb-1"><i class="fa fa-users"></i> –†–æ–¥–∏—Ç–µ–ª—å: {{ student.parent_name }}</p>
                                        <p class="mb-1"><i class="fa fa-phone"></i> –¢–µ–ª. —Ä–æ–¥–∏—Ç–µ–ª—è: {{ student.parent_phone|default:"–Ω–µ—Ç" }}</p>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>
                                        <div class="progress mb-2" style="height: 5px;">
                                            <div class="progress-bar bg-success" style="width: 90%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between text-center">
                                            <div>
                                                <small class="text-muted">–£—Ä–æ–∫–æ–≤</small>
                                                <h6>{{ student.lesson_attendance.count }}</h6>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="btn-group w-100">
                                        <a href="{% url 'teacher_student_detail' student.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fa fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
                                        </a>
                                        <a href="{% url 'teacher_homework_create_for_student' student.id %}" class="btn btn-sm btn-outline-success">
                                            <i class="fa fa-book"></i> –î–ó
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-info">
                                            <i class="fa fa-chart-line"></i> –û—Ç—á–µ—Ç
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fa fa-users fa-4x text-muted mb-3"></i>
                        <h5>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</h5>
                        <p class="text-muted">–£—á–µ–Ω–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–ø–∏—à—É—Ç—Å—è –∫ –≤–∞–º –Ω–∞ —É—Ä–æ–∫–∏</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –í—ã–ø–ª–∞—Ç—ã -->
        <div class="tab-pane fade" id="payments" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <h4 class="mb-4"><i class="fa fa-money mr-2"></i> –ú–æ–∏ –≤—ã–ø–ª–∞—Ç—ã</h4>

                    <!-- –ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stat-card text-center p-4">
                                <div class="stat-number" style="font-size: 2.5rem;">{{ finance.wallet_balance }}</div>
                                <div class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                                {% if finance.wallet_balance > 0 %}
                                <a href="{% url 'teacher_request_payment' %}" class="btn btn-success btn-sm mt-3">
                                    <i class="fa fa-money"></i> –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–ª–∞—Ç</h5>
                                    <div class="row mt-3">
                                        <div class="col-4 text-center">
                                            <h3>{{ finance.payment_stats.count }}</h3>
                                            <small class="text-muted">–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—Ç</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <h3>{{ finance.payment_stats.average|floatformat:0 }} ‚ÇΩ</h3>
                                            <small class="text-muted">–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <h3 class="text-success">{{ finance.payment_stats.total|floatformat:0 }} ‚ÇΩ</h3>
                                            <small class="text-muted">–í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç -->
                    <h5 class="mb-3">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h5>
                    {% if recent_payments %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.created_at|date:"d.m.Y H:i" }}</td>
                                    <td class="text-success">+{{ payment.amount }} ‚ÇΩ</td>
                                    <td>{{ payment.description|default:"–í—ã–ø–ª–∞—Ç–∞" }}</td>
                                    <td><span class="badge badge-success">–ó–∞—á–∏—Å–ª–µ–Ω–æ</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if all_payments.count > 10 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'teacher_payments' %}" class="btn btn-outline-primary">
                            –í—Å–µ –≤—ã–ø–ª–∞—Ç—ã ({{ all_payments.count }})
                        </a>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fa fa-money fa-4x text-muted mb-3"></i>
                        <h5>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç –ø—É—Å—Ç–∞</h5>
                        <p class="text-muted">–í—ã–ø–ª–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É—Ä–æ–∫–æ–≤</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
        <div class="tab-pane fade" id="materials" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fa fa-file mr-2"></i> –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
                        <a href="{% url 'teacher_material_create' %}" class="btn-create" style="padding: 8px 15px;">
                            <i class="fa fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                        </a>
                    </div>

                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <form method="get" class="form-inline justify-content-between">
                                <div class="form-group mr-2">
                                    <label for="subject-filter" class="mr-2">–ü—Ä–µ–¥–º–µ—Ç:</label>
                                    <select id="subject-filter" name="subject" class="form-control form-control-sm">
                                        <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group mr-2">
                                    <label for="type-filter" class="mr-2">–¢–∏–ø:</label>
                                    <select id="type-filter" name="type" class="form-control form-control-sm">
                                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                        <option value="file">üìÑ –§–∞–π–ª—ã</option>
                                        <option value="link">üîó –°—Å—ã–ª–∫–∏</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <input type="text" name="search" class="form-control form-control-sm"
                                           placeholder="–ü–æ–∏—Å–∫..." style="width: 200px;">
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fa fa-search"></i> –ù–∞–π—Ç–∏
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                    {% if materials %}
                    <div class="row">
                        {% for material in materials %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="material-icon mr-3">
                                            {% if material.material_type == 'file' %}
                                            <i class="fa fa-file-pdf-o fa-3x text-danger"></i>
                                            {% else %}
                                            <i class="fa fa-link fa-3x text-primary"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ material.title }}</h6>
                                            <small class="text-muted">
                                                {% for subject in material.subjects.all %}
                                                {{ subject.name }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                        </div>
                                    </div>

                                    <p class="small text-muted mb-3">
                                        {{ material.description|truncatechars:100 }}
                                    </p>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fa fa-clock-o"></i> {{ material.created_at|date:"d.m.Y" }}
                                        </small>
                                        <div>
                                            <a href="{{ material.get_absolute_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fa fa-download"></i> –û—Ç–∫—Ä—ã—Ç—å
                                            </a>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="shareMaterial({{ material.id }})">
                                                <i class="fa fa-share-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fa fa-eye"></i> {{ material.views|default:0 }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                                        </small>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'teacher_material_edit' material.id %}" class="btn btn-outline-warning">
                                                <i class="fa fa-edit"></i>
                                            </a>
                                            <a href="{% url 'teacher_material_delete' material.id %}" class="btn btn-outline-danger"
                                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?')">
                                                <i class="fa fa-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fa fa-file fa-4x text-muted mb-3"></i>
                        <h5>–ù–µ—Ç –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>
                        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ —Å—Å—ã–ª–∫–∏ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤</p>
                        <a href="{% url 'teacher_material_create' %}" class="btn btn-primary">
                            <i class="fa fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    function shareMaterial(materialId) {
        const url = window.location.origin + '/material/' + materialId + '/';
        navigator.clipboard.writeText(url).then(function() {
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        }).catch(function(err) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        });
    }

    // FULLCALENDAR
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'ru',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: '–°–µ–≥–æ–¥–Ω—è',
                    month: '–ú–µ—Å—è—Ü',
                    week: '–ù–µ–¥–µ–ª—è',
                    day: '–î–µ–Ω—å'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: false,
                slotDuration: '00:30:00',
                events: {{ calendar_events|safe }},
                eventDisplay: 'block',
                displayEventTime: false,
                eventClick: function(info) {
                    if (info.event.url) {
                        window.location.href = info.event.url;
                        info.jsEvent.preventDefault();
                    }
                },
                selectConstraint: {
                    start: '08:00',
                    end: '22:00',
                },
                selectAllow: function(selectInfo) {
                    const events = calendar.getEvents();
                    const newEvent = {
                        start: selectInfo.start,
                        end: selectInfo.end
                    };
                    const isOverlap = events.some(event => {
                        return (
                            newEvent.start < event.end &&
                            newEvent.end > event.start
                        );
                    });
                    if (isOverlap) {
                        alert('–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
                        return false;
                    }
                    const duration = (selectInfo.end - selectInfo.start) / 60000;
                    if (duration < 30) {
                        alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî 30 –º–∏–Ω—É—Ç');
                        return false;
                    }
                    return true;
                },
                businessHours: {
                    daysOfWeek: [1, 2, 3, 4, 5],
                    startTime: '08:00',
                    endTime: '22:00'
                }
            });
            calendar.render();
        }
    });
</script>
{% endblock %}