{% extends 'base.html' %}
{% load static %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É—á–∏—Ç–µ–ª—è{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet'/>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (—Ç–æ–ª—å–∫–æ –∏–º—è) -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ user.first_name }}!</h2>
        </div>
    </div>

    <!-- –ö–æ—à–µ–ª–µ–∫ —É—á–∏—Ç–µ–ª—è -->
<!--    <div class="row">
        <div class="col-12">
            <div class="wallet-card">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="wallet-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞</div>
                        <div class="wallet-amount">{{ wallet_balance|floatformat:0 }} ‚ÇΩ</div>
                        <div class="wallet-sub">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞</div>
                    </div>
                </div>
            </div>
        </div>
    </div>-->

    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number">{{ students.count }}</div>
            <div class="stat-label">–£—á–µ–Ω–∏–∫–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ upcoming_lessons|length }}</div>
            <div class="stat-label">–ë–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ today_lessons|length }}</div>
            <div class="stat-label">–ó–∞–Ω—è—Ç–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ materials|length }}</div>
            <div class="stat-label">–ú–æ–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
        </div>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<!--    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="payment-stat">
                <div class="stat-number">{{ total_paid|default:'0'|floatformat:0 }} ‚ÇΩ</div>
                <div class="stat-label">–í—ã–ø–ª–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="payment-stat">
                <div class="stat-number">{{ pending_payment|default:'0'|floatformat:0 }} ‚ÇΩ</div>
                <div class="stat-label">–û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="payment-stat">
                <div class="stat-number">{{ completed_lessons_count|default:'0' }}</div>
                <div class="stat-label">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π</div>
            </div>
        </div>
    </div>-->

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs-custom" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab">
                <i class="fa fa-calendar"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="students-tab" data-toggle="tab" href="#students" role="tab">
                <i class="fa fa-users"></i> –ú–æ–∏ —É—á–µ–Ω–∏–∫–∏
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="homeworks-tab" data-toggle="tab" href="#homeworks" role="tab">
                <i class="fa fa-book"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="payments-tab" data-toggle="tab" href="#payments" role="tab">
                <i class="fa fa-money"></i> –í—ã–ø–ª–∞—Ç—ã
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="materials-tab" data-toggle="tab" href="#materials" role="tab">
                <i class="fa fa-file"></i> –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab">
                <i class="fa fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π
            </a>
        </li>
    </ul>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å) -->
        <div class="tab-pane fade show active" id="schedule" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–æ–∏ —É—á–µ–Ω–∏–∫–∏ -->
        <div class="tab-pane fade" id="students" role="tabpanel">
            <div class="students-grid">
                {% if students %}
                {% for student in students %}
                <div class="student-card-small">
                    <div class="student-info-small">
                        <h6>{{ student.user.get_full_name }}</h6>
                        <p class="text-muted">
                            <i class="fa fa-envelope"></i> {{ student.user.email|truncatechars:20 }}
                        </p>
                        <p class="text-muted">
                            <i class="fa fa-phone"></i> {{ student.user.phone|default:"–Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞" }}
                        </p>
                    </div>
                    <a href="{% url 'teacher_student_detail' student.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fa fa-users"></i>
                        <h5>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</h5>
                        <p>–°–∫–æ—Ä–æ –≤–∞–º –±—É–¥—É—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —É—á–µ–Ω–∏–∫–∏</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
        <div class="tab-pane fade" id="homeworks" role="tabpanel">
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <h4 class="section-title mb-0">–í—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h4>
                    <a href="{% url 'teacher_homeworks' %}" class="btn btn-success">
                        <i class="fa fa-book"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="stats-grid">
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.total|default:'0' }}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.pending|default:'0' }}</div>
                            <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.submitted|default:'0' }}</div>
                            <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.checked|default:'0' }}</div>
                            <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.overdue|default:'0' }}</div>
                            <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    {% if recent_homeworks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–£—á–µ–Ω–∏–∫</th>
                                    <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                    <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for homework in recent_homeworks %}
                                <tr>
                                    <td>{{ homework.created_at|date:"d.m.Y" }}</td>
                                    <td>{{ homework.student.user.get_full_name }}</td>
                                    <td>{{ homework.subject.name }}</td>
                                    <td>{{ homework.title|truncatechars:30 }}</td>
                                    <td>
                                        {% with status=homework.get_status %}
                                            {% if status == 'pending' %}
                                                <span class="badge badge-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                                            {% elif status == 'submitted' %}
                                                <span class="badge badge-info">üì§ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                            {% elif status == 'checked' %}
                                                <span class="badge badge-success">‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                            {% elif status == 'overdue' %}
                                                <span class="badge badge-danger">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <a href="{% url 'teacher_homework_detail' homework.id %}"
                                           class="btn btn-sm btn-primary">
                                            <i class="fa fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="empty-state">
                                            <i class="fa fa-book"></i>
                                            <h5>–ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</h5>
                                            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤</p>
                                            <a href="{% url 'teacher_homeworks' %}" class="btn btn-primary mt-3">
                                                <i class="fa fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –í—ã–ø–ª–∞—Ç—ã -->
        <div class="tab-pane fade" id="payments" role="tabpanel">
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="section-title">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    {% if recent_payments %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–ü–µ—Ä–∏–æ–¥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.created_at|date:"d.m.Y" }}</td>
                                <td><strong>{{ payment.amount|floatformat:2 }} ‚ÇΩ</strong></td>
                                <td>{{ payment.description|default:"–í—ã–ø–ª–∞—Ç–∞" }}</td>
                                <td>
                                    <span class="badge badge-success">–í—ã–ø–ª–∞—á–µ–Ω–æ</span>
                                </td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-outline-secondary">
                                        <i class="fa fa-download"></i> –ö–≤–∏—Ç–∞–Ω—Ü–∏—è
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="empty-state">
                                        <i class="fa fa-money"></i>
                                        <h5>–ï—â–µ –Ω–µ –±—ã–ª–æ –≤—ã–ø–ª–∞—Ç</h5>
                                        <p>–í—ã–ø–ª–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fa fa-money"></i>
                        <h5>–ï—â–µ –Ω–µ –±—ã–ª–æ –≤—ã–ø–ª–∞—Ç</h5>
                        <p>–í—ã–ø–ª–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
        <div class="tab-pane fade" id="materials" role="tabpanel">
            <div class="row mb-3">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <h4 class="section-title mb-0">–ú–æ–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
                    <a href="{% url 'teacher_materials' %}" class="btn btn-primary">
                        <i class="fa fa-plus"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-3">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="filterMaterials('all')">–í—Å–µ</button>
                        <button class="btn btn-outline-primary" onclick="filterMaterials('file')">–§–∞–π–ª—ã</button>
                        <button class="btn btn-outline-primary" onclick="filterMaterials('link')">–°—Å—ã–ª–∫–∏</button>
                    </div>
                </div>
            </div>

            <div class="row">
                {% if materials %}
                {% for material in materials %}
                <div class="col-md-6 material-item" data-type="{{ material.material_type }}">
                    <div class="material-card">
                        <div class="d-flex align-items-start">
                            <div class="material-icon">
                                {% if material.material_type == 'file' %}
                                <i class="fa fa-file-pdf-o text-danger"></i>
                                {% else %}
                                <i class="fa fa-link text-primary"></i>
                                {% endif %}
                            </div>
                            <div style="flex: 1;">
                                <h5>{{ material.title }}</h5>
                                <p class="text-muted small">{{ material.description|truncatechars:100 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fa fa-calendar"></i> {{ material.created_at|date:"d.m.Y" }}
                                    </small>
                                    <div>
                                        <span class="badge badge-info">{{ material.get_material_type_display }}</span>
                                    </div>
                                </div>
                                {% if material.subjects.exists %}
                                <div class="mt-2">
                                    {% for subject in material.subjects.all %}
                                    <span class="badge badge-secondary">{{ subject.name }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fa fa-file"></i>
                        <h5>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <h4 class="section-title">–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è</h4>
                    {% if completed_lessons %}
                    {% for lesson in completed_lessons %}
                    <div class="lesson-item completed">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong>{{ lesson.date|date:"d.m.Y" }}</strong>
                            </div>
                            <div class="col-md-3">
                                <strong>{{ lesson.subject.name }}</strong><br>
                                <small class="text-muted">{{ lesson.student.user.get_full_name }}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge badge-success">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</span>
                            </div>
                            <div class="col-md-2">
                                <strong>{{ lesson.teacher_payment|floatformat:2 }} ‚ÇΩ</strong>
                            </div>
                            <div class="col-md-3 text-right">
                                {% if lesson.report %}
                                <a href="{% url 'teacher_lesson_detail' lesson.id %}" class="btn btn-sm btn-info">
                                    <i class="fa fa-file-text"></i> –û—Ç—á–µ—Ç
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fa fa-history"></i>
                        <h5>–ù–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π</h5>
                        <p>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: '–°–µ–≥–æ–¥–Ω—è',
                month: '–ú–µ—Å—è—Ü',
                week: '–ù–µ–¥–µ–ª—è',
                day: '–î–µ–Ω—å'
            },
            slotMinTime: '08:00:00',
            slotMaxTime: '22:00:00',
            allDaySlot: false,
            events: [
                {% for lesson in all_lessons %}
                {
                    title: '{{ lesson.subject.name }} - {{ lesson.student.user.last_name }}',
                    start: '{{ lesson.date|date:"Y-m-d" }}T{{ lesson.start_time|time:"H:i:s" }}',
                    end: '{{ lesson.date|date:"Y-m-d" }}T{{ lesson.end_time|time:"H:i:s" }}',
                    url: "{% url 'teacher_lesson_detail' lesson.id %}",
                    backgroundColor: '{% if lesson.status == "completed" %}#28a745{% elif lesson.status == "cancelled" %}#dc3545{% elif lesson.status == "overdue" %}#fd7e14{% else %}#007bff{% endif %}',
                    borderColor: '{% if lesson.status == "completed" %}#28a745{% elif lesson.status == "cancelled" %}#dc3545{% elif lesson.status == "overdue" %}#fd7e14{% else %}#007bff{% endif %}',
                    textColor: 'white'
                },
                {% endfor %}
            ],
            eventClick: function(info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    info.jsEvent.preventDefault();
                }
            }
        });
        calendar.render();
    });

    function filterMaterials(type) {
        const items = document.querySelectorAll('.material-item');
        items.forEach(item => {
            if (type === 'all' || item.dataset.type === type) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}