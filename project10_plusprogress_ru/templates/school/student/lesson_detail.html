{% extends 'base.html' %}
{% load static %}

{% block title %}–£—Ä–æ–∫ {{ lesson.subject.name }} - {{ lesson.date }}{% endblock %}

{% block extra_css %}
<style>
    .lesson-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .lesson-header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .lesson-header .badge { font-size: 1rem; padding: 10px 20px; border-radius: 30px; }
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
    }
    .teacher-photo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #667eea;
    }
    .student-photo-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #667eea;
    }
    .zoom-link {
        display: inline-block;
        padding: 15px 30px;
        background: #2d8cff;
        color: white;
        border-radius: 50px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s;
    }
    .zoom-link:hover {
        background: #1a5bbf;
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }
    .btn-video {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
        margin-bottom: 10px;
        display: inline-block;
        text-decoration: none;
    }
    .btn-video:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        color: white;
        text-decoration: none;
    }
    .btn-video:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    .btn-video:disabled:hover {
        transform: none;
        box-shadow: none;
    }
    .status-badge { padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 600; }
    .status-scheduled { background: #cce5ff; color: #004085; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-overdue { background: #fff3cd; color: #856404; }

    /* –°–¢–ê–¢–£–° */
    .status-badge-large {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 15px 20px;
        border-radius: 50px;
        text-align: center;
        margin-bottom: 20px;
    }
    .status-scheduled-large {
        background: #cce5ff;
        color: #004085;
        border: 2px solid #004085;
    }
    .status-completed-large {
        background: #d4edda;
        color: #155724;
        border: 2px solid #155724;
    }
    .status-cancelled-large {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #721c24;
    }
    .status-overdue-large {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #856404;
    }
    .status-rescheduled-large {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #856404;
    }
    .status-no_show-large {
        background: #e2e3e5;
        color: #383d41;
        border: 2px solid #383d41;
    }

    /* –ó–ê–ß–ï–†–ö–ù–£–¢–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨ */
    .strikethrough {
        text-decoration: line-through;
        color: #999;
    }

    .rating-stars-input {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 10px;
    }
    .rating-stars-input input { display: none; }
    .rating-stars-input label {
        font-size: 50px;
        color: #ddd;
        cursor: pointer;
        transition: all 0.3s;
    }
    .rating-stars-input label:hover,
    .rating-stars-input label:hover~label,
    .rating-stars-input input:checked~label {
        color: #ffd700;
        transform: scale(1.1);
    }
    .btn-rating {
        background: linear-gradient(45deg, #ffc107, #ff9800);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-rating:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
    }
    .video-note {
        background: #e8f4fd;
        border-left: 4px solid #2196f3;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    .waiting-room {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .students-list {
        margin-top: 20px;
    }
    .student-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    .student-item:last-child {
        border-bottom: none;
    }
    .student-item .student-info {
        flex: 1;
        margin-left: 15px;
    }
    .student-item .student-name {
        font-weight: 600;
        color: #333;
    }
    .student-item .student-status {
        font-size: 0.85rem;
    }
    .student-item .badge {
        padding: 5px 10px;
        border-radius: 20px;
    }
    .student-item.current-user {
        background: #e7f5ff;
        border-radius: 8px;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    .section-title i {
        margin-right: 8px;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ö–†–£–ü–ù–´–ô –°–¢–ê–¢–£–° –£–†–û–ö–ê -->
<div class="status-badge-large status-{{ lesson.status }}-large" style="font-size: 2.5rem; padding: 30px; text-align: center;">
    {% if lesson.status == 'scheduled' %}üîµ –£—Ä–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
    {% elif lesson.status == 'completed' %}üü¢ –£—Ä–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω
    {% elif lesson.status == 'cancelled' %}üî¥ –£—Ä–æ–∫ –æ—Ç–º–µ–Ω–µ–Ω
    {% elif lesson.status == 'overdue' %}üü† –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
    {% elif lesson.status == 'rescheduled' %}üü° –£—Ä–æ–∫ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω
    {% elif lesson.status == 'no_show' %}‚ö™ –£—á–∞—â–∏–π—Å—è –Ω–µ —è–≤–∏–ª—Å—è
    {% endif %}
</div>

<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
    <div class="lesson-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>{{ lesson.subject.name }}</h1>
                <p class="mb-2">
                    <i class="fa fa-calendar"></i> {{ lesson.date|date:"d.m.Y" }}
                    <i class="fa fa-clock ml-3"></i> {{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}
                </p>
                <p class="mb-0">
                    <span class="badge status-{{ lesson.status }} status-badge">
                        {% if lesson.status == 'scheduled' %}–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
                        {% elif lesson.status == 'completed' %}–ü—Ä–æ–≤–µ–¥–µ–Ω–æ
                        {% elif lesson.status == 'cancelled' %}–û—Ç–º–µ–Ω–µ–Ω–æ
                        {% elif lesson.status == 'overdue' %}–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                        {% elif lesson.status == 'rescheduled' %}–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ
                        {% elif lesson.status == 'no_show' %}–ù–µ—è–≤–∫–∞
                        {% endif %}
                    </span>
                </p>
            </div>
            <div class="col-md-4 text-right">
                {% if lesson.status == 'scheduled' and lesson.meeting_link %}
                <a href="{{ lesson.meeting_link }}" target="_blank" class="zoom-link">
                    <i class="fa fa-video-camera"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è (Zoom)
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-md-4">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–∏—Ç–µ–ª—è -->
            <div class="info-card text-center">
                <h5><i class="fa fa-user"></i> –£—á–∏—Ç–µ–ª—å</h5>
                {% if lesson.teacher.user.photo %}
                <img src="{{ lesson.teacher.user.photo.url }}" class="teacher-photo mb-3" alt="">
                {% else %}
                <div class="teacher-photo bg-secondary d-flex align-items-center justify-content-center mb-3 mx-auto">
                    <i class="fa fa-user fa-3x text-white"></i>
                </div>
                {% endif %}
                <h4>{{ lesson.teacher.user.get_full_name }}</h4>
                <p class="text-muted">
                    {% for subject in lesson.teacher.subjects.all %}
                    {{ subject.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ä–æ–∫–µ -->
            <div class="info-card">
                <h5><i class="fa fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong></td>
                        <td>{{ lesson.subject.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong></td>
                        <td>
                            {% if lesson.status == 'completed' or lesson.status == 'scheduled' %}
                            <span class="font-weight-bold">{{ attendance.cost }} ‚ÇΩ</span>
                            {% else %}
                            <span class="strikethrough">{{ attendance.cost }} ‚ÇΩ</span>
                            <span class="badge badge-secondary ml-2">–Ω–µ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>–î–∞—Ç–∞:</strong></td>
                        <td>{{ lesson.date|date:"d.m.Y" }}</td>
                    </tr>
                    <tr>
                        <td><strong>–í—Ä–µ–º—è:</strong></td>
                        <td>{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</td>
                    </tr>
                </table>
            </div>

            <!-- –í–ò–î–ï–û-–ó–í–û–ù–û–ö JITSI –î–õ–Ø –£–ß–ï–ù–ò–ö–ê -->
            {% if lesson.status == 'scheduled' %}
            <div class="info-card">
                <h5><i class="fa fa-video-camera"></i> –í–∏–¥–µ–æ-—É—Ä–æ–∫</h5>
                {% if lesson.video_room %}
                <div class="alert alert-success">
                    <i class="fa fa-check-circle"></i> –£—á–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É—Ä–æ–∫–∞!
                </div>
                {% with room_name="plusprogress-"|add:lesson.id|stringformat:"s"|add:"-"|add:lesson.video_room %}
                <a href="https://meet.jit.si/{{ room_name }}#userInfo.displayName={{ request.user.get_full_name|urlencode }}&userInfo.email={{ request.user.email|urlencode }}&config.startWithAudioMuted=false"
                   target="_blank"
                   class="btn-video">
                    <i class="fa fa-video-camera"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —É—Ä–æ–∫—É
                </a>
                <div class="video-note text-left mt-3">
                    <p><i class="fa fa-info-circle text-primary"></i> <strong>–í–∞–∂–Ω–æ:</strong></p>
                    <ul class="pl-3 mb-0">
                        <li>–í—ã –≤–æ–π–¥–µ—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –∏–º–µ–Ω–µ–º: <strong>{{ request.user.get_full_name }}</strong></li>
                        <li>–ï—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –µ—â–µ –Ω–µ –∑–∞—à–µ–ª, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ–≥–æ –≤ –∫–æ–º–Ω–∞—Ç–µ</li>
                    </ul>
                </div>
                {% endwith %}
                {% else %}
                <div class="waiting-room">
                    <i class="fa fa-clock fa-2x text-warning mb-2"></i>
                    <h6>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã</h6>
                    <p class="mb-0">–£—á–∏—Ç–µ–ª—å –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É—Ä–æ–∫–∞. –°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å, –∫–∞–∫ —Ç–æ–ª—å–∫–æ —É—á–∏—Ç–µ–ª—å –Ω–∞—á–Ω–µ—Ç —É—Ä–æ–∫.</p>
                </div>
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                    </div>
                    <p class="mt-2 text-muted">–û–∂–∏–¥–∞–µ–º —É—á–∏—Ç–µ–ª—è...</p>
                </div>
                <script>
                    setTimeout(function() {
                        location.reload();
                    }, 30000);
                </script>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-md-8">
            <!-- ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –£–ß–ê–°–¢–ù–ò–ö–ò –£–†–û–ö–ê -->
            <div class="info-card">
                <h5 class="section-title"><i class="fa fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏ —É—Ä–æ–∫–∞ ({{ attendances.count }})</h5>
                <div class="students-list">
                    {% for student_attendance in attendances %}
                    <div class="student-item {% if student_attendance.student.user == request.user %}current-user{% endif %}">
                        {% if student_attendance.student.user.photo %}
                        <img src="{{ student_attendance.student.user.photo.url }}" class="student-photo-small" alt="">
                        {% else %}
                        <div class="student-photo-small bg-secondary d-flex align-items-center justify-content-center">
                            <i class="fa fa-user fa-lg text-white"></i>
                        </div>
                        {% endif %}
                        <div class="student-info">
                            <div class="student-name">
                                <!-- ‚úÖ –ò–º—è + –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ —Ñ–∞–º–∏–ª–∏–∏ -->
                                {{ student_attendance.student.user.first_name }}
                                {% if student_attendance.student.user.last_name %}
                                    {{ student_attendance.student.user.last_name|first }}.
                                {% endif %}

                                {% if student_attendance.student.user == request.user %}
                                <span class="badge badge-primary ml-2">–≠—Ç–æ –≤—ã</span>
                                {% endif %}
                            </div>
                            <div class="student-status">
                                {% if lesson.status == 'completed' %}
                                    <span class="badge badge-success">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</span>
                                {% else %}
                                    <span class="badge badge-info">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    {% endfor %}
                </div>
            </div>

            <!-- –û—Ç—á–µ—Ç -->
            {% if lesson.status == 'completed' and lesson.report %}
            <div class="info-card">
                <h5><i class="fa fa-file-text"></i> –û—Ç—á–µ—Ç</h5>
                <p><strong>–¢–µ–º–∞:</strong> {{ lesson.report.topic }}</p>
                <p><strong>–ß—Ç–æ –ø—Ä–æ—à–ª–∏:</strong> {{ lesson.report.covered_material }}</p>
                <p><strong>–î–ó:</strong> {{ lesson.report.homework }}</p>
                <p><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å:</strong> {{ lesson.report.student_progress }}</p>
            </div>

            <!-- –û—Ü–µ–Ω–∫–∞ -->
            <div class="info-card">
                <h5><i class="fa fa-star"></i> –û—Ü–µ–Ω–∫–∞</h5>
                {% if lesson.feedback %}
                <div class="text-center">
                    <div class="rating-stars mb-3">
                        {% for i in "12345"|make_list %}
                        {% if forloop.counter <= lesson.feedback.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                    </div>
                    {% if lesson.feedback.comment %}
                    <p>{{ lesson.feedback.comment }}</p>
                    {% endif %}
                </div>
                {% else %}
                <form method="post">
                    {% csrf_token %}
                    <div class="text-center mb-4">
                        <div class="rating-stars-input">
                            <input type="radio" name="rating" value="5" id="star5"><label for="star5">‚òÖ</label>
                            <input type="radio" name="rating" value="4" id="star4"><label for="star4">‚òÖ</label>
                            <input type="radio" name="rating" value="3" id="star3"><label for="star3">‚òÖ</label>
                            <input type="radio" name="rating" value="2" id="star2"><label for="star2">‚òÖ</label>
                            <input type="radio" name="rating" value="1" id="star1"><label for="star1">‚òÖ</label>
                        </div>
                    </div>
                    <textarea name="comment" class="form-control mb-3" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_public" class="form-check-input" id="is_public">
                        <label class="form-check-label" for="is_public">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ</label>
                    </div>
                    <button type="submit" class="btn btn-rating btn-block">–û—Ü–µ–Ω–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const labels = document.querySelectorAll('.rating-stars-input label');
        labels.forEach(label => {
            label.addEventListener('mouseover', function() {
                let val = this.getAttribute('for').replace('star', '');
                labels.forEach(l => l.style.color = '#ddd');
                for(let i = 5; i >= val; i--) {
                    let l = document.querySelector(`label[for="star${i}"]`);
                    if(l) l.style.color = '#ffd700';
                }
            });
            label.addEventListener('mouseout', function() {
                let checked = document.querySelector('input[name="rating"]:checked');
                if(checked) {
                    let val = checked.value;
                    labels.forEach(l => l.style.color = '#ddd');
                    for(let i = 5; i >= val; i--) {
                        let l = document.querySelector(`label[for="star${i}"]`);
                        if(l) l.style.color = '#ffd700';
                    }
                } else {
                    labels.forEach(l => l.style.color = '#ddd');
                }
            });
        });
    });
</script>
{% endblock %}