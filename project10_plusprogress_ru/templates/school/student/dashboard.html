{% extends 'base.html' %}
{% load static %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É—á–µ–Ω–∏–∫–∞{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    /* === –°–¢–ò–õ–ò –î–õ–Ø –ë–ê–õ–ê–ù–°–ê === */
    .balance-positive {
        color: white !important;  /* –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π - –±–µ–ª—ã–π */
    }
    
    .balance-negative {
        color: #dc3545 !important;  /* –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π - –∫—Ä–∞—Å–Ω—ã–π */
        font-weight: bold !important;
    }
    
    .balance-amount {
        font-size: 48px !important;
        font-weight: bold !important;
        line-height: 1.2 !important;
    }
    
    /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ - –û–î–ù–û –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ */
    .balance-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .balance-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 5px;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ user.first_name }}!</h2>
            <p class="text-muted">–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ</p>
        </div>
    </div>

    <!-- –ë–∞–ª–∞–Ω—Å —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π -->
    <div class="row">
        <div class="col-12">
            <div class="balance-card">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="balance-amount {% if user.balance < 0 %}balance-negative{% else %}balance-positive{% endif %}">
                        {{ user.balance }} ‚ÇΩ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number">{{ upcoming_lessons|length }}</div>
            <div class="stat-label">–ë–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ past_lessons|length }}</div>
            <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ teachers|length }}</div>
            <div class="stat-label">–£—á–∏—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ materials|length }}</div>
            <div class="stat-label">–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
        </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
    {% if recent_homeworks %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa fa-book"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h5>
                    <a href="{% url 'student_homeworks' %}" class="btn btn-sm btn-light">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è ‚Üí</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for homework in recent_homeworks %}
                        <div class="col-md-6 mb-3">
                            <div class="homework-item p-3 border rounded {% if homework.get_status == 'overdue' %}bg-light-danger{% endif %}">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">
                                        <a href="{% url 'student_homework_detail' homework.id %}" class="text-dark">
                                            {{ homework.title }}
                                        </a>
                                    </h6>
                                    <span class="badge badge-{{ homework.get_status }}">
                                        {{ homework.get_status_display }}
                                    </span>
                                </div>
                                <p class="mb-1 small text-muted">
                                    <i class="fa fa-user"></i> {{ homework.teacher.user.get_full_name }} |
                                    <i class="fa fa-calendar"></i> –¥–æ {{ homework.deadline|date:"d.m.Y H:i" }}
                                </p>
                                {% if homework.get_status == 'submitted' %}
                                <span class="badge badge-info">–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs-custom" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab">
                <i class="fa fa-calendar"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="homeworks-tab" data-toggle="tab" href="#homeworks" role="tab">
                <i class="fa fa-book"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="teachers-tab" data-toggle="tab" href="#teachers" role="tab">
                <i class="fa fa-users"></i> –ú–æ–∏ —É—á–∏—Ç–µ–ª—è
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="materials-tab" data-toggle="tab" href="#materials" role="tab">
                <i class="fa fa-file"></i> –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab">
                <i class="fa fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π
            </a>
        </li>
    </ul>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
        <div class="d-flex gap-2">
            <form method="get" action="{% url 'export_calendar_pdf' %}" class="d-flex gap-2" target="_blank">
                <input type="date" name="start_date" class="form-control form-control-sm" value="{{ now|date:'Y-m-01' }}">
                <input type="date" name="end_date" class="form-control form-control-sm" value="{{ now|date:'Y-m-t' }}">
                <button type="submit" class="btn btn-success btn-sm">
                    üìÑ –≠–∫—Å–ø–æ—Ä—Ç
                </button>
            </form>
        </div>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
        <div class="tab-pane fade show active" id="schedule" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
        <div class="tab-pane fade" id="homeworks" role="tabpanel">
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <h4 class="section-title mb-0">–í—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h4>
                    <a href="{% url 'student_homeworks' %}" class="btn btn-success">
                        <i class="fa fa-book"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="stats-grid">
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.total|default:'0' }}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.pending|default:'0' }}</div>
                            <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.submitted|default:'0' }}</div>
                            <div class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.checked|default:'0' }}</div>
                            <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                        </div>
                        <div class="stat-card-small">
                            <div class="stat-number">{{ stats.overdue|default:'0' }}</div>
                            <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    {% if homeworks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–£—á–∏—Ç–µ–ª—å</th>
                                    <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                                    <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                                    <th>–°—Ä–æ–∫</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for homework in homeworks %}
                                <tr>
                                    <td>{{ homework.created_at|date:"d.m.Y" }}</td>
                                    <td>{{ homework.teacher.user.get_full_name }}</td>
                                    <td>{{ homework.subject.name }}</td>
                                    <td>{{ homework.title|truncatechars:30 }}</td>
                                    <td>{{ homework.deadline|date:"d.m.Y" }}</td>
                                    <td>
                                        {% with status=homework.get_status %}
                                        {% if status == 'pending' %}
                                        <span class="badge badge-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                                        {% elif status == 'submitted' %}
                                        <span class="badge badge-info">üì§ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                        {% elif status == 'checked' %}
                                        <span class="badge badge-success">‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                        {% elif status == 'overdue' %}
                                        <span class="badge badge-danger">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                        {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <a href="{% url 'student_homework_detail' homework.id %}" class="btn btn-sm btn-primary">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="empty-state">
                                            <i class="fa fa-book"></i>
                                            <h5>–ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</h5>
                                            <p>–ó–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–Ω—è—Ç–∏–π</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–æ–∏ —É—á–∏—Ç–µ–ª—è -->
        <div class="tab-pane fade" id="teachers" role="tabpanel">
            <div class="row">
                {% if teachers %}
                {% for teacher in teachers %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="teacher-card">
                        {% if teacher.user.photo %}
                        <img src="{{ teacher.user.photo.url }}" class="teacher-photo" alt="{{ teacher.user.get_full_name }}">
                        {% else %}
                        <div class="teacher-photo bg-secondary d-flex align-items-center justify-content-center">
                            <i class="fa fa-user fa-4x text-white"></i>
                        </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ teacher.user.get_full_name }}</h5>
                            <p class="card-text">
                                <small class="text-muted">
                                    {% for subject in teacher.subjects.all %}
                                    {{ subject.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </small>
                            </p>
                            <p class="card-text">
                                <i class="fa fa-star text-warning"></i> –û–ø—ã—Ç: {{ teacher.experience }} –ª–µ—Ç
                            </p>

                            {% if teacher.rating_stats %}
                            <div class="mb-2">
                                <span class="rating-stars">
                                    {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= teacher.rating_stats.average_rating %}‚òÖ{% else %}‚òÜ{% endif%} {% endfor %} </span>
                                        <small class="text-muted ml-1">({{ teacher.rating_stats.total_feedbacks }}
                                            –æ—Ü–µ–Ω–æ–∫)</small>
                            </div>
                            {% endif %}

                            <a href="#" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#teacherModal{{ teacher.id }}">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </a>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—á–∏—Ç–µ–ª—è -->
                <div class="modal fade" id="teacherModal{{ teacher.id }}" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{{ teacher.user.get_full_name }}</h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        {% if teacher.user.photo %}
                                        <img src="{{ teacher.user.photo.url }}" class="img-fluid rounded" alt="">
                                        {% endif %}
                                    </div>
                                    <div class="col-md-8">
                                        <h6>–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ:</h6>
                                        <p>{{ teacher.bio|default:"–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" }}</p>
                                        <h6>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:</h6>
                                        <p>{{ teacher.education|default:"–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" }}</p>
                                        <h6>–ü—Ä–µ–¥–º–µ—Ç—ã:</h6>
                                        <p>
                                            {% for subject in teacher.subjects.all %}
                                            <span class="badge badge-info">{{ subject.name }}</span>
                                            {% endfor %}
                                        </p>

                                        {% if teacher.rating_stats %}
                                        <h6>–†–µ–π—Ç–∏–Ω–≥:</h6>
                                        <div class="mb-3">
                                            <div class="rating-stars mb-2">
                                                {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= teacher.rating_stats.average_rating %}‚òÖ{% else %}‚òÜ{% endif %} {% endfor %} <span class="ml-2">{{
                                                    teacher.rating_stats.average_rating|floatformat:1 }} / 5</span>
                                            </div>
                                            <small class="text-muted">–ù–∞ –æ—Å–Ω–æ–≤–µ {{ teacher.rating_stats.total_feedbacks
                                                }} –æ—Ü–µ–Ω–æ–∫</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fa fa-users"></i>
                        <h5>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∏—Ç–µ–ª–µ–π</h5>
                        <p>–°–∫–æ—Ä–æ –≤–∞–º –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
        <div class="tab-pane fade" id="materials" role="tabpanel">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="filterMaterials('all')">–í—Å–µ</button>
                        <button class="btn btn-outline-primary" onclick="filterMaterials('file')">–§–∞–π–ª—ã</button>
                        <button class="btn btn-outline-primary" onclick="filterMaterials('link')">–°—Å—ã–ª–∫–∏</button>
                    </div>
                </div>
            </div>

            <div class="row">
                {% if materials %}
                {% for material in materials %}
                <div class="col-md-6 material-item" data-type="{{ material.material_type }}">
                    <div class="material-card">
                        <div class="d-flex align-items-start">
                            <div class="material-icon">
                                {% if material.material_type == 'file' %}
                                <i class="fa fa-file-pdf-o text-danger"></i>
                                {% else %}
                                <i class="fa fa-link text-primary"></i>
                                {% endif %}
                            </div>
                            <div style="flex: 1;">
                                <h5>{{ material.title }}</h5>
                                <p class="text-muted small">{{ material.description|truncatechars:100 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fa fa-calendar"></i> {{ material.created_at|date:"d.m.Y" }}
                                    </small>
                                    {% if material.material_type == 'file' %}
                                    <a href="{{ material.file.url }}" class="btn btn-sm btn-success" download>
                                        <i class="fa fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                    </a>
                                    {% else %}
                                    <a href="{{ material.link }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fa fa-external-link"></i> –ü–µ—Ä–µ–π—Ç–∏
                                    </a>
                                    {% endif %}
                                </div>
                                {% if material.subjects.exists %}
                                <div class="mt-2">
                                    {% for subject in material.subjects.all %}
                                    <span class="badge badge-secondary">{{ subject.name }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fa fa-file"></i>
                        <h5>–ù–µ—Ç –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h5>
                        <p>–£—á–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–∑–∂–µ</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <h4 class="section-title">–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è</h4>
                    {% if past_lessons %}
                    {% for lesson in past_lessons %}
                    <a href="{% url 'lesson_detail' lesson.id %}" style="text-decoration: none; color: inherit;">
                        <div class="lesson-item completed">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>{{ lesson.date|date:"d.m.Y" }}</strong><br>
                                    <small class="text-muted">{{ lesson.start_time|time:"H:i" }}</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>{{ lesson.subject.name }}</strong><br>
                                    <small class="text-muted">{{ lesson.teacher.user.get_full_name }}</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge badge-success">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</span>
                                </div>
                                <div class="col-md-4 text-right">
                                    {% if lesson.report %}
                                    <span class="btn btn-sm btn-info disabled">
                                        <i class="fa fa-file-text"></i> –û—Ç—á–µ—Ç
                                    </span>
                                    {% endif %}

                                    {% if lesson.feedback %}
                                    <span class="feedback-badge">
                                        <i class="fa fa-star text-warning"></i>
                                        –í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:
                                        <span class="rating-stars">
                                            {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= lesson.feedback.rating %}‚òÖ{% else %}‚òÜ{% endif %} {% endfor %} </span>
                                        </span>
                                        {% else %}
                                        <span class="btn btn-sm btn-rating disabled">
                                            <i class="fa fa-star"></i> –û—Ü–µ–Ω–∏—Ç—å —É—Ä–æ–∫
                                        </span>
                                        {% endif %}
                                </div>
                            </div>

                            {% if lesson.feedback and lesson.feedback.comment %}
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="bg-light p-2 rounded">
                                        <i class="fa fa-quote-left text-muted"></i>
                                        {{ lesson.feedback.comment|truncatechars:100 }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fa fa-history"></i>
                        <h5>–ù–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π</h5>
                        <p>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç undefined
    function updateExportLink(view) {
        var btn = document.getElementById('exportPdfBtn');
        if (!btn || !view || !view.currentStart) return;  // ‚Üê –ó–ê–©–ò–¢–ê!
        
        var date = view.currentStart.toISOString().split('T')[0];
        btn.href = "{% url 'export_calendar_pdf' %}?view=" + view.type + "&date=" + date;
        console.log('üìÖ –°—Å—ã–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', btn.href);
    }

    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'ru',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: '–°–µ–≥–æ–¥–Ω—è',
            month: '–ú–µ—Å—è—Ü',
            week: '–ù–µ–¥–µ–ª—è',
            day: '–î–µ–Ω—å'
        },
        events: {{ calendar_events|safe }},
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        datesSet: function(info) {
            // –ù–ï–ë–û–õ–¨–®–ê–Ø –ó–ê–î–ï–†–ñ–ö–ê, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–æ—á–Ω–æ –ø—Ä–æ–≥—Ä—É–∑–∏–ª—Å—è
            setTimeout(function() {
                updateExportLink(info.view);
            }, 100);
        }
    });

    calendar.render();
    
    // –ë–∞–ª–∞–Ω—Å
    var balanceEl = document.querySelector('.balance-amount');
    if (balanceEl) {
        var balance = parseFloat('{{ user.balance }}');
        if (balance < 0) {
            balanceEl.style.color = '#dc3545';
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(function() {
        if (calendar && calendar.view) {
            updateExportLink(calendar.view);
        }
    }, 200);
});
</script>
{% endblock %}