{% extends "admin/change_form.html" %}
{% load i18n static %}

{% block object-tools-items %}
{{ block.super }}
<!-- –£–î–ê–õ–Ø–ï–ú –î–£–ë–õ–ò–†–£–Æ–©–£–Æ–°–Ø –ö–ù–û–ü–ö–£ –ò–ó –í–ï–†–•–ù–ï–ô –ü–ê–ù–ï–õ–ò -->
{% endblock %}

{% block after_field_sets %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'scss/main.css' %}">

{% if original and original.status == 'completed' %}
<div class="module" style="margin-top: 20px;">
    <h2>–û—Ç—á–µ—Ç –æ –∑–∞–Ω—è—Ç–∏–∏</h2>

    {% if original.report %}
    <div style="padding: 15px; background: #f8f8f8; border-radius: 4px;">
        <p><strong>–¢–µ–º–∞:</strong> {{ original.report.topic }}</p>
        <p><strong>–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª:</strong></p>
        <p>{{ original.report.covered_material|linebreaks }}</p>
        <p><strong>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:</strong></p>
        <p>{{ original.report.homework|linebreaks }}</p>
        <p><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–∞:</strong></p>
        <p>{{ original.report.student_progress|linebreaks }}</p>
        {% if original.report.next_lesson_plan %}
        <p><strong>–ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è:</strong></p>
        <p>{{ original.report.next_lesson_plan|linebreaks }}</p>
        {% endif %}
        <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ original.report.created_at }}</p>
    </div>
    {% endif %}
</div>
{% endif %}

{% if original and original.status != 'completed' and original.status != 'cancelled' %}
<div class="module" style="margin-top: 20px; border: 2px solid #28a745; padding: 15px; background: #f8fff8;">
    <h2 style="color: #28a745;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</h2>

    <!-- –ü–†–û–°–¢–ê–Ø –§–û–†–ú–ê - –±–µ–∑ JavaScript, –æ–±—ã—á–Ω—ã–π POST -->
    <form method="post" action="/admin/school/lesson/{{ original.pk }}/complete/">
        {% csrf_token %}
        <table style="width: 100%;">
            <tr>
                <td style="width: 200px;"><label for="topic">–¢–µ–º–∞ –∑–∞–Ω—è—Ç–∏—è:</label></td>
                <td><input type="text" id="topic" name="topic" class="vTextField" style="width: 100%;" required></td>
            </tr>
            <tr>
                <td><label for="covered_material">–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª:</label></td>
                <td><textarea id="covered_material" name="covered_material" rows="4" style="width: 100%;"
                        required></textarea></td>
            </tr>
            <tr>
                <td><label for="homework">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:</label></td>
                <td><textarea id="homework" name="homework" rows="3" style="width: 100%;" required></textarea></td>
            </tr>
            <tr>
                <td><label for="student_progress">–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–∞:</label></td>
                <td><textarea id="student_progress" name="student_progress" rows="3" style="width: 100%;"
                        required></textarea></td>
            </tr>
            <tr>
                <td><label for="next_lesson_plan">–ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è:</label></td>
                <td><textarea id="next_lesson_plan" name="next_lesson_plan" rows="3" style="width: 100%;"></textarea>
                </td>
            </tr>
        </table>

        <div class="submit-row" style="margin-top: 20px;">
            <input type="submit" value="‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ –∏ —Å–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞" class="default"
                style="background: #28a745; font-size: 16px; padding: 10px 20px;">
        </div>
    </form>
</div>
{% endif %}

<!-- –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    function ensureCompleteForm() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ñ–æ—Ä–º–∞
        if (document.querySelector('form[action*="complete"]')) {
            console.log('‚úÖ –§–æ—Ä–º–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ –¥–ª—è —Ñ–æ—Ä–º—ã
        const block = document.querySelector('.module[style*="28a745"]');
        if (!block) {
            console.log('‚ùå –ë–ª–æ–∫ –¥–ª—è —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º ID —É—Ä–æ–∫–∞ –∏–∑ URL
        const match = window.location.pathname.match(/\/lesson\/(\d+)\//);
        if (!match) {
            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —É—Ä–æ–∫–∞');
            return;
        }
        const lessonId = match[1];

        console.log(`üîß –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —É—Ä–æ–∫–∞ ${lessonId}...`);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const h2 = block.querySelector('h2');
        const title = h2 ? h2.outerHTML : '<h2 style="color: #28a745;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</h2>';

        // –û—á–∏—â–∞–µ–º –±–ª–æ–∫
        block.innerHTML = title;

        // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/school/lesson/${lessonId}/complete/`;

        // CSRF —Ç–æ–∫–µ–Ω
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrf);

        // –ü–æ–ª—è —Ñ–æ—Ä–º—ã
        const fields = [
            {name: 'topic', label: '–¢–µ–º–∞ –∑–∞–Ω—è—Ç–∏—è:', type: 'text', required: true},
            {name: 'covered_material', label: '–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª:', type: 'textarea', required: true},
            {name: 'homework', label: '–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:', type: 'textarea', required: true},
            {name: 'student_progress', label: '–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–∞:', type: 'textarea', required: true},
            {name: 'next_lesson_plan', label: '–ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è:', type: 'textarea', required: false}
        ];

        const table = document.createElement('table');
        table.style.width = '100%';

        fields.forEach(field => {
            const tr = document.createElement('tr');

            // –Ø—á–µ–π–∫–∞ —Å label
            const tdLabel = document.createElement('td');
            tdLabel.style.width = '200px';
            tdLabel.style.verticalAlign = 'top';
            tdLabel.style.padding = '5px';
            const label = document.createElement('label');
            label.htmlFor = field.name;
            label.textContent = field.label;
            tdLabel.appendChild(label);
            tr.appendChild(tdLabel);

            // –Ø—á–µ–π–∫–∞ —Å input
            const tdInput = document.createElement('td');
            tdInput.style.padding = '5px';

            if (field.type === 'textarea') {
                const textarea = document.createElement('textarea');
                textarea.id = field.name;
                textarea.name = field.name;
                textarea.rows = field.name === 'covered_material' ? 4 : 3;
                textarea.style.width = '100%';
                textarea.style.padding = '5px';
                if (field.required) textarea.required = true;
                tdInput.appendChild(textarea);
            } else {
                const input = document.createElement('input');
                input.type = field.type;
                input.id = field.name;
                input.name = field.name;
                input.className = 'vTextField';
                input.style.width = '100%';
                input.style.padding = '5px';
                if (field.required) input.required = true;
                tdInput.appendChild(input);
            }

            tr.appendChild(tdInput);
            table.appendChild(tr);
        });

        form.appendChild(table);

        // –ö–Ω–æ–ø–∫–∞ submit
        const div = document.createElement('div');
        div.className = 'submit-row';
        div.style.marginTop = '20px';
        div.style.padding = '10px';

        const button = document.createElement('input');
        button.type = 'submit';
        button.value = '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ –∏ —Å–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞';
        button.className = 'default';
        button.style.background = '#28a745';
        button.style.fontSize = '16px';
        button.style.padding = '10px 20px';
        button.style.border = 'none';
        button.style.cursor = 'pointer';
        button.style.color = 'white';
        button.style.borderRadius = '4px';

        div.appendChild(button);
        form.appendChild(div);

        block.appendChild(form);

        console.log('‚úÖ –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!');
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', ensureCompleteForm);

    // –ò –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOM –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é)
    setTimeout(ensureCompleteForm, 1000);
// ‚úÖ –§–ò–ö–° –î–õ–Ø –î–ê–¢–´
document.addEventListener('DOMContentLoaded', function() {
    var dateField = document.getElementById('id_date');
    if (dateField) {
        // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞
        {% if original and original.date %}
        var lessonDate = "{{ original.date|date:'Y-m-d' }}";
        dateField.value = lessonDate;
        console.log('üìÖ –î–∞—Ç–∞ —É—Ä–æ–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', lessonDate);
        {% endif %}

        // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞ –∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
        if (!dateField.value) {
            var today = new Date().toISOString().split('T')[0];
            dateField.value = today;
            console.log('üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞:', today);
        }
    }
});

</script>
{% endblock %}