{% extends "admin/change_form.html" %}
{% load i18n static %}

{% block after_field_sets %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'scss/main.css' %}">

{% if original and original.status == 'completed' %}
<div class="module" style="margin-top: 20px;">
    <h2>Отчет о занятии</h2>

    {% if original.report %}
    <div style="padding: 15px; background: #f8f8f8; border-radius: 4px;">
        <p><strong>Тема:</strong> {{ original.report.topic }}</p>
        <p><strong>Пройденный материал:</strong></p>
        <p>{{ original.report.covered_material|linebreaks }}</p>
        <p><strong>Домашнее задание:</strong></p>
        <p>{{ original.report.homework|linebreaks }}</p>
        <p><strong>Прогресс ученика:</strong></p>
        <p>{{ original.report.student_progress|linebreaks }}</p>
        {% if original.report.next_lesson_plan %}
        <p><strong>План следующего занятия:</strong></p>
        <p>{{ original.report.next_lesson_plan|linebreaks }}</p>
        {% endif %}
        <p><strong>Создан:</strong> {{ original.report.created_at }}</p>
    </div>
    {% endif %}
</div>
{% endif %}

{% if original and original.status != 'completed' and original.status != 'cancelled' %}
<div class="module" style="margin-top: 20px;">
    <h2>Завершить занятие</h2>

    <form id="complete-lesson-form" method="post" action="{% url 'admin:complete-lesson' original.pk %}">
        {% csrf_token %}
        <table style="width: 100%;">
            <tr>
                <td><label for="topic">Тема занятия:</label></td>
                <td><input type="text" id="topic" name="topic" class="vTextField" style="width: 100%;" required></td>
            </tr>
            <tr>
                <td><label for="covered_material">Пройденный материал:</label></td>
                <td><textarea id="covered_material" name="covered_material" rows="4" style="width: 100%;"
                        required></textarea></td>
            </tr>
            <tr>
                <td><label for="homework">Домашнее задание:</label></td>
                <td><textarea id="homework" name="homework" rows="3" style="width: 100%;" required></textarea></td>
            </tr>
            <tr>
                <td><label for="student_progress">Прогресс ученика:</label></td>
                <td><textarea id="student_progress" name="student_progress" rows="3" style="width: 100%;"
                        required></textarea></td>
            </tr>
            <tr>
                <td><label for="next_lesson_plan">План следующего занятия:</label></td>
                <td><textarea id="next_lesson_plan" name="next_lesson_plan" rows="3" style="width: 100%;"></textarea>
                </td>
            </tr>
        </table>

        <div class="submit-row" style="margin-top: 20px;">
            <input type="submit" value="Завершить занятие и создать отчет" class="default" style="background: #28a745;">
        </div>
    </form>
</div>
{% endif %}
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
    (function ($) {
        $('#complete-lesson-form').on('submit', function (e) {
            e.preventDefault();

            if (confirm('Вы уверены? После завершения занятия баланс ученика будет уменьшен, а учителю начислена выплата.')) {
                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            alert('Занятие успешно завершено!');
                            location.reload();
                        } else {
                            alert('Ошибка: ' + response.error);
                        }
                    },
                    error: function () {
                        alert('Произошла ошибка при сохранении');
                    }
                });
            }
        });
    })(django.jQuery);
</script>
{% endblock %}