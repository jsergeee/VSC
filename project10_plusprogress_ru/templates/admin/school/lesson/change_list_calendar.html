{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1100px;
        margin: 20px auto;
        height: 600px;
    }
    .fc-event {
        cursor: pointer;
    }
    .fc-event-title {
        font-weight: 500;
    }
    .view-toggle {
        margin-bottom: 20px;
        text-align: right;
    }
    .view-toggle a {
        display: inline-block;
        margin-left: 10px;
        padding: 8px 16px;
        border: 1px solid #79aec8;
        border-radius: 4px;
        background: white;
        color: #333;
        text-decoration: none;
    }
    .view-toggle a.active {
        background: #79aec8;
        color: white;
    }
    .back-link {
        margin-bottom: 20px;
    }
    .back-link a {
        color: #447e9b;
        text-decoration: none;
    }
    .back-link a:hover {
        text-decoration: underline;
    }
    .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 10px;
        background: #f8f8f8;
        border-radius: 4px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    .legend-color.scheduled { background-color: #007bff; }
    .legend-color.completed { background-color: #28a745; }
    .legend-color.overdue { background-color: #dc3545; }
    .legend-color.cancelled { background-color: #fd7e14; }
    .legend-color.rescheduled { background-color: #9b59b6; }
    .legend-color.no_show { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <div class="back-link">
            <a href=".">← Вернуться к списку</a>
        </div>
        
        <div class="view-toggle">
            <a href=".">Список</a>
            <a href="?view=calendar" class="active">Календарь</a>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color scheduled"></div>
                <span>Запланировано</span>
            </div>
            <div class="legend-item">
                <div class="legend-color completed"></div>
                <span>Проведено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color overdue"></div>
                <span>Просрочено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color cancelled"></div>
                <span>Отменено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color rescheduled"></div>
                <span>Перенесено</span>
            </div>
            <div class="legend-item">
                <div class="legend-color no_show"></div>
                <span>Не явился</span>
            </div>
        </div>

        <div id="calendar"></div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'ru',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: 'Сегодня',
            month: 'Месяц',
            week: 'Неделя',
            day: 'День'
        },
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        slotDuration: '00:30:00',
        
        events: [
            {% for lesson in lessons %}
            {
                title: '{{ lesson.teacher.user.last_name }} - {{ lesson.subject.name }}{% if lesson.student %} ({{ lesson.student.user.last_name }}){% endif %}',
                start: '{{ lesson.date|date:"Y-m-d" }}T{{ lesson.start_time|time:"H:i:s" }}',
                end: '{{ lesson.date|date:"Y-m-d" }}T{{ lesson.end_time|time:"H:i:s" }}',
                color: '{% if lesson.status == "scheduled" %}#007bff{% elif lesson.status == "completed" %}#28a745{% elif lesson.status == "overdue" %}#dc3545{% elif lesson.status == "cancelled" %}#fd7e14{% elif lesson.status == "rescheduled" %}#9b59b6{% else %}#6c757d{% endif %}',
                url: '{% url "admin:school_lesson_change" lesson.id %}'
            },
            {% endfor %}
        ],
        
        eventClick: function(info) {
            if (info.event.url) {
                window.location.href = info.event.url;
            }
        },
        
        eventDidMount: function(info) {
            // Добавляем тултип с дополнительной информацией
            var props = info.event.extendedProps;
            var title = info.event.title;
            info.el.setAttribute('title', title);
        }
    });
    
    calendar.render();
});
</script>
{% endblock %}