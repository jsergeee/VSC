{% extends "admin/change_list.html" %}
{% load i18n static admin_list %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .student-stats-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
        background: white;
        border: 1px solid #ddd;
    }
    .student-stats-table th {
        background-color: #417690;
        color: white;
        font-weight: bold;
        padding: 10px;
        text-align: left;
    }
    .student-stats-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
    }
    .student-stats-table tr:hover {
        background-color: #f5f5f5;
    }
    .balance-negative {
        color: #dc3545;
        font-weight: bold;
    }
    .balance-positive {
        color: #28a745;
        font-weight: bold;
    }
    .balance-zero {
        color: #6c757d;
    }
    .stats-toggle {
        cursor: pointer;
        color: #417690;
        font-weight: bold;
        margin: 15px 0 5px 0;
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
    }
    .stats-toggle:hover {
        background-color: #e0e0e0;
    }
    .subject-badge {
        background-color: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 5px;
        font-size: 12px;
        display: inline-block;
        margin-bottom: 3px;
    }
    .period-filter {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    .period-filter label {
        margin-right: 10px;
        font-weight: bold;
    }
    .period-filter input {
        margin-right: 15px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    .period-filter button {
        background-color: #417690;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 3px;
        cursor: pointer;
    }
    .period-filter button:hover {
        background-color: #2c5a73;
    }
    .period-filter .reset {
        background-color: #6c757d;
        color: white;
        padding: 6px 15px;
        border-radius: 3px;
        text-decoration: none;
        margin-left: 10px;
    }
    .period-filter .reset:hover {
        background-color: #5a6268;
    }
</style>
{% endblock %}

<!-- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–æ–∫ object-tools-items, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
{% block object-tools-items %}
<!-- –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥–∏–º - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç—ã -->
{% endblock %}

{% block content %}
<div id="content-main">
    <!-- –ù–∞—à–µ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π -->
    <div style="margin-bottom: 10px; text-align: right;">
        <div style="display: inline-block; position: relative;">
            <button onclick="toggleActions()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                ‚ö° –î–µ–π—Å—Ç–≤–∏—è —Å —É—á–µ–Ω–∏–∫–∞–º–∏ <span id="actionsIcon">‚ñº</span>
            </button>

            <div id="actionsMenu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; z-index: 1000; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <ul style="list-style: none; margin: 0; padding: 0;">
                    <li style="border-bottom: 1px solid #eee;">
                        <a href="{% url 'admin:school_student_add' %}" style="display: block; padding: 10px 15px; text-decoration: none; color: #333;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
                        </a>
                    </li>
                    <li style="border-bottom: 1px solid #eee;">
                        <a href="{% url 'import-students' %}" style="display: block; padding: 10px 15px; text-decoration: none; color: #333;">
                            üì• –ò–º–ø–æ—Ä—Ç —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑ Excel
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'import_users' %}" style="display: block; padding: 10px 15px; text-decoration: none; color: #333;">
                            üë• –ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É (–∫–∞–∫ —É —É—á–∏—Ç–µ–ª–µ–π) -->
    <div class="period-filter">
        <div class="stats-toggle" onclick="toggleFilter()">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É ‚ñº</div>
        <div id="periodFilterContent" style="display: block;">
            <form method="get" id="period-filter-form">
                <label for="start_date">–î–∞—Ç–∞ —Å:</label>
                <input type="date" name="start_date" id="start_date" value="{{ start_date|default:'' }}">

                <label for="end_date">–î–∞—Ç–∞ –ø–æ:</label>
                <input type="date" name="end_date" id="end_date" value="{{ end_date|default:'' }}">

                <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="." class="reset">–°–±—Ä–æ—Å</a>
            </form>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
    {% if students_data %}
    <div style="margin-top: 20px; border-top: 2px solid #79aec8; padding-top: 20px;">
        <div class="stats-toggle" onclick="toggleStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚ñº</div>
        <div id="studentStats" style="display: block;">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ {{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}</h2>

            <table class="student-stats-table">
                <thead>
                    <tr>
                        <th>–£—á–µ–Ω–∏–∫</th>
                        <th>–í—Å–µ–≥–æ —É—Ä–æ–∫–æ–≤</th>
                        <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
                        <th>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</th>
                        <th>–î–µ—Ç–∞–ª–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in students_data %}
                    <tr>
                        <td>
                            <a href="{% url 'admin:school_student_change' data.student.id %}">
                                {{ data.student.user.get_full_name }}
                            </a>
                        </td>
                        <td>{{ data.lessons_count }}</td>
                        <td>{{ data.total_cost|floatformat:"2" }} ‚ÇΩ</td>
                        <td class="
                            {% if data.balance < 0 %}balance-negative
                            {% elif data.balance > 0 %}balance-positive
                            {% else %}balance-zero{% endif %}">
                            {{ data.balance|floatformat:"2" }} ‚ÇΩ
                        </td>
                        <td>
                            {% for subj in data.subjects_stats %}
                            <span class="subject-badge">
                                {{ subj.lesson__subject__name }}: {{ subj.count }} —É—Ä. = {{ subj.total|floatformat:"0" }}‚ÇΩ
                            </span>
                            {% empty %}
                            <span class="subject-badge">–Ω–µ—Ç —É—Ä–æ–∫–æ–≤</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background-color: #f0f0f0; font-weight: bold;">
                        <td>–ò–¢–û–ì–û:</td>
                        <td>{{ total_lessons|default:0 }}</td>
                        <td>{{ total_cost|default:0|floatformat:"2" }} ‚ÇΩ</td>
                        <td>{{ total_balance|default:0|floatformat:"2" }} ‚ÇΩ</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div style="margin-top: 30px;">
        <h2>–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</h2>
        {% result_list cl %}
        {% pagination cl %}
    </div>
</div>

<script>
    function toggleActions() {
        var menu = document.getElementById('actionsMenu');
        var icon = document.getElementById('actionsIcon');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        icon.innerHTML = menu.style.display === 'block' ? '‚ñ≤' : '‚ñº';
    }

    function toggleFilter() {
        var filter = document.getElementById('periodFilterContent');
        var toggle = document.querySelector('.period-filter .stats-toggle');
        filter.style.display = filter.style.display === 'none' ? 'block' : 'none';
        toggle.innerHTML = filter.style.display === 'block' ? 'üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É ‚ñº' : 'üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É ‚ñ∂';
    }

    function toggleStats() {
        var stats = document.getElementById('studentStats');
        var toggle = document.querySelectorAll('.stats-toggle')[1];
        stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
        toggle.innerHTML = stats.style.display === 'block' ? 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚ñº' : 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚ñ∂';
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function (event) {
        var menu = document.getElementById('actionsMenu');
        var button = event.target.closest('button');
        if (!button || !button.innerText.includes('‚ö° –î–µ–π—Å—Ç–≤–∏—è')) {
            menu.style.display = 'none';
            document.getElementById('actionsIcon').innerHTML = '‚ñº';
        }
    });
</script>
{% endblock %}